<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ï–ª–∏–∑–∞–≤–µ—Ç–∞ | AI-—á–∞—Ç —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–æ–≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º Tesseract.js –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --dark-color: #2d3436;
            --light-color: #f5f6fa;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --error-color: #d63031;
            --lua-color: #000080;
            
            /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã */
            --bg-color: #f9f9f9;
            --text-color: #2d3436;
            --container-bg: white;
            --message-bot-bg: #f5f6fa;
            --message-user-bg: #6c5ce7;
            --message-user-text: white;
            --input-bg: white;
            --input-border: #eee;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --timestamp-color: #b2bec3;
            --quick-reply-bg: #f5f6fa;
            --quick-reply-border: #dfe6e9;
            --tool-bg: #f1f3f5;
            --tool-border: #dee2e6;
        }

        .dark-mode {
            --bg-color: #1a1a2e;
            --text-color: #f5f6fa;
            --container-bg: #16213e;
            --message-bot-bg: #0f3460;
            --message-user-bg: #6c5ce7;
            --message-user-text: white;
            --input-bg: #0f3460;
            --input-border: #1a1a2e;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --timestamp-color: #a0a0a0;
            --quick-reply-bg: #0f3460;
            --quick-reply-border: #1a1a2e;
            --tool-bg: #1e2a4a;
            --tool-border: #2d3748;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥—É–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π */
        .custom-function-container {
            background-color: var(--tool-bg);
            border: 1px solid var(--tool-border);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .custom-function-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .custom-function-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .custom-function-input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        .custom-function-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
            margin-bottom: 10px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .custom-function-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .custom-function-btn:hover {
            background-color: #5a4bd1;
        }
        
        .custom-function-btn.save {
            background-color: var(--success-color);
        }
        
        .custom-function-btn.delete {
            background-color: var(--error-color);
        }
        
        .custom-functions-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .custom-function-item {
            background-color: var(--container-bg);
            border: 1px solid var(--input-border);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .custom-function-item:hover {
            background-color: var(--message-bot-bg);
        }
        
        .custom-function-item-title {
            font-weight: 500;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .custom-function-item-desc {
            font-size: 0.8rem;
            color: var(--timestamp-color);
        }
        
        .function-tag {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            touch-action: manipulation;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            padding: 0 5px;
        }

        .logo {
            font-size: clamp(1.8rem, 6vw, 2.5rem);
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo::before, .logo::after {
            content: "‚ú¶";
            margin: 0 10px;
            color: var(--accent-color);
            font-size: clamp(1.2rem, 5vw, 1.8rem);
        }

        .tagline {
            color: var(--timestamp-color);
            font-size: clamp(0.8rem, 3vw, 1rem);
            font-weight: 500;
        }

        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-color);
            transition: transform 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .limit-counter {
            background-color: var(--message-bot-bg);
            border-radius: 15px;
            padding: 6px 10px;
            margin: 8px auto;
            font-size: 0.75rem;
            color: var(--text-color);
            display: inline-block;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .limit-counter.warning {
            background-color: var(--warning-color);
            color: #000;
        }

        .limit-counter.error {
            background-color: var(--error-color);
            color: white;
        }

        .chat-container {
            background-color: var(--container-bg);
            border-radius: 15px;
            box-shadow: 0 5px 15px var(--shadow-color);
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            max-height: calc(100vh - 250px);
            min-height: 60vh;
        }

        .message {
            margin-bottom: 12px;
            max-width: 90%;
            padding: 12px 15px;
            border-radius: 15px;
            position: relative;
            animation: fadeIn 0.3s ease;
            line-height: 1.5;
            font-size: 0.9rem;
            word-break: break-word;
            transition: background-color 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            background-color: var(--message-bot-bg);
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }

        .user-message {
            background-color: var(--message-user-bg);
            color: var(--message-user-text);
            border-bottom-right-radius: 5px;
            align-self: flex-end;
            margin-left: auto;
        }

        .input-area {
            display: flex;
            gap: 8px;
            margin-top: auto;
            padding: 5px;
            align-items: center;
            position: sticky;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 10;
            transition: background-color 0.3s;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 25px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s;
            background-color: var(--input-bg);
            color: var(--text-color);
            min-height: 50px;
            max-height: 120px;
            resize: none;
            overflow-y: auto;
            -webkit-appearance: none;
            -webkit-border-radius: 25px;
        }

        #user-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        #send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0 20px;
            height: 50px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            -webkit-appearance: none;
            -webkit-border-radius: 25px;
        }

        #send-button:hover {
            background-color: #5a4bd1;
        }

        #send-button:active {
            transform: scale(0.95);
        }

        .typing-indicator {
            display: flex;
            padding: 12px 15px;
            background-color: var(--message-bot-bg);
            border-radius: 15px;
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            margin-bottom: 12px;
            display: none;
        }

        .typing-dot {
            width: 7px;
            height: 7px;
            background-color: var(--timestamp-color);
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .timestamp {
            font-size: 0.65rem;
            color: var(--timestamp-color);
            margin-top: 4px;
            text-align: right;
        }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .quick-reply {
            background-color: var(--quick-reply-bg);
            border: 1px solid var(--quick-reply-border);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-color);
        }

        .quick-reply:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .quick-reply:active {
            transform: scale(0.95);
        }

        .mood-indicator {
            font-size: 0.75rem;
            margin-top: 4px;
            color: var(--timestamp-color);
            display: flex;
            align-items: center;
        }

        .mood-icon {
            margin-right: 4px;
            font-size: 0.9rem;
        }

        .learn-message {
            font-size: 0.75rem;
            color: var(--success-color);
            margin-top: 4px;
            font-style: italic;
        }

        .status-message {
            font-size: 0.75rem;
            color: var(--timestamp-color);
            margin-top: 4px;
            text-align: center;
            padding: 4px;
        }

        .limit-message {
            font-size: 0.75rem;
            color: var(--error-color);
            margin-top: 4px;
            text-align: center;
            padding: 4px;
            font-weight: 500;
        }

        .speech-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .speech-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 3px 8px;
            font-size: 0.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .speech-btn:hover {
            background-color: #8c7ae6;
        }

        .speech-btn:active {
            transform: scale(0.95);
        }

        .speech-btn.active {
            background-color: var(--accent-color);
        }

        .code-block {
            background-color: var(--dark-color);
            color: #f8f8f2;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            margin: 5px 0;
            overflow-x: auto;
            border-left: 3px solid var(--lua-color);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            color: #f8f8f2;
            font-size: 0.7rem;
        }

        .copy-code {
            background-color: var(--lua-color);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 0.6rem;
            cursor: pointer;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .tool-container {
            background-color: var(--tool-bg);
            border: 1px solid var(--tool-border);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        .tool-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .tool-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .tool-input {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .tool-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-button:hover {
            background-color: #5a4bd1;
        }

        .tool-result {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--container-bg);
            border-radius: 5px;
            word-break: break-all;
        }

        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }

        #qr-code {
            margin: 10px 0;
        }

        .download-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 5px;
            transition: all 0.2s;
        }

        .download-btn:hover {
            background-color: #00a884;
        }

        .password-strength {
            height: 5px;
            background-color: #ddd;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .strength-meter {
            height: 100%;
            width: 0;
            transition: width 0.3s;
        }

        .strength-weak {
            background-color: var(--error-color);
        }

        .strength-medium {
            background-color: var(--warning-color);
        }

        .strength-strong {
            background-color: var(--success-color);
        }

        .color-preview {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            margin: 10px auto;
            border: 1px solid var(--input-border);
        }

        .converter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .converter-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .converter-select {
            padding: 8px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .note-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
            margin-bottom: 10px;
            resize: vertical;
        }

        .note-controls {
            display: flex;
            gap: 10px;
        }

        .note-save {
            background-color: var(--success-color);
            color: white;
        }

        .note-clear {
            background-color: var(--error-color);
            color: white;
        }

        .timer-display {
            font-size: 2rem;
            text-align: center;
            margin: 10px 0;
            font-family: monospace;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .timer-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timer-start {
            background-color: var(--success-color);
            color: white;
        }

        .timer-pause {
            background-color: var(--warning-color);
            color: black;
        }

        .timer-reset {
            background-color: var(--error-color);
            color: white;
        }

        .calculator-display {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: right;
            font-size: 1.5rem;
            font-family: monospace;
            overflow-x: auto;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .calc-btn {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: var(--tool-bg);
            color: var(--text-color);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calc-btn:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .calc-btn-operator {
            background-color: var(--primary-color);
            color: white;
        }

        .calc-btn-equals {
            background-color: var(--success-color);
            color: white;
        }

        .calc-btn-clear {
            background-color: var(--error-color);
            color: white;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ */
        .file-upload-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .file-upload-btn:hover {
            background-color: var(--primary-color);
            transform: scale(1.1);
        }

        .file-info {
            font-size: 0.8rem;
            color: var(--timestamp-color);
            margin-right: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        .file-message {
            font-size: 0.8rem;
            color: var(--accent-color);
            margin-top: 5px;
            display: flex;
            align-items: center;
        }

        .file-icon {
            margin-right: 5px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .ocr-progress {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-top: 5px;
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                padding: 8px;
                height: auto;
                min-height: 100vh;
            }
            .chat-container {
                padding: 10px;
                border-radius: 12px;
                flex: 1 1 auto;
            }
            .chat-messages {
                max-height: calc(100vh - 220px);
                min-height: calc(100vh - 220px);
            }
            .message {
                max-width: 95%;
                padding: 10px 12px;
                font-size: 0.85rem;
                margin-bottom: 10px;
            }
            #user-input {
                padding: 10px 12px;
                font-size: 0.9rem;
                min-height: 45px;
            }
            #send-button {
                height: 45px;
                padding: 0 15px;
                font-size: 0.9rem;
            }
            .typing-indicator {
                padding: 10px 12px;
            }
            .quick-reply {
                padding: 5px 10px;
                font-size: 0.7rem;
            }
            .tool-controls {
                flex-direction: column;
            }
            .tool-input {
                width: 100%;
            }
            .calculator-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
            .calc-btn {
                padding: 8px;
                font-size: 1rem;
            }
            @supports (-webkit-touch-callout: none) {
                .container {
                    min-height: -webkit-fill-available;
                    height: -webkit-fill-available;
                }
                .chat-messages {
                    max-height: calc(100vh - 220px);
                    min-height: calc(100vh - 220px);
                }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="theme-toggle" id="theme-toggle">üåô</button>
            <div class="logo">–ï–ª–∏–∑–∞–≤–µ—Ç–∞</div>
            <div class="tagline">–í–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–æ–≤</div>
            <div class="limit-counter" id="limit-counter"></div>
        </header>
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
            <div class="typing-indicator" id="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        <div class="input-area">
            <label for="file-input" class="file-upload-btn">üìÅ</label>
            <input type="file" id="file-input" accept=".txt,.html,.htm,.jpg,.jpeg,.png,.gif" style="display: none;">
            <textarea id="user-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" rows="1"></textarea>
            <button id="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const limitCounter = document.getElementById('limit-counter');
        const themeToggle = document.getElementById('theme-toggle');
        const fileInput = document.getElementById('file-input');
        const fileUploadBtn = document.querySelector('.file-upload-btn');
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
        const REQUEST_LIMIT = 50;
        const HOUR_IN_MS = 60 * 60 * 1000;
        
        // Firebase configuration
        const FIREBASE_URL = 'https://alliza-dceed-default-rtdb.firebaseio.com/';
        const KNOWLEDGE_PATH = '/knowledge.json';
        const CUSTOM_FUNCTIONS_PATH = '/customFunctions.json';
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
        const dialogState = {
            context: [],
            userMood: 'neutral',
            currentTopic: null,
            lastAction: null,
            userName: null,
            isLearningMode: false,
            learningData: {
                category: null,
                topic: null
            },
            speechSettings: {
                enabled: true,
                voice: null,
                rate: 1.0,
                pitch: 1.0,
                volume: 1.0
            },
            darkMode: localStorage.getItem('darkMode') === 'true',
            activeTool: null,
            timer: {
                running: false,
                startTime: 0,
                elapsed: 0,
                interval: null
            },
            notes: JSON.parse(localStorage.getItem('userNotes')) || {},
            currentFile: null,
            customFunctions: {} // –î–æ–±–∞–≤–ª—è–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
        };

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (dialogState.darkMode) {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = '‚òÄÔ∏è';
        }

        // –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        let knowledgeBase = {
            programming: {
                'lua': {
                    description: "Lua - —ç—Ç–æ –ª–µ–≥–∫–∏–π, –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π, –º—É–ª—å—Ç–∏–ø–∞—Ä–∞–¥–∏–≥–º–∞–ª—å–Ω—ã–π —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.",
                    basics: `-- –≠—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ Lua
-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
local number = 42
local string = "–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!"
local boolean = true
local table = {1, 2, 3, key = "value"}

-- –£—Å–ª–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
if number > 40 then
    print("–ß–∏—Å–ª–æ –±–æ–ª—å—à–µ 40")
elseif number < 40 then
    print("–ß–∏—Å–ª–æ –º–µ–Ω—å—à–µ 40")
else
    print("–ß–∏—Å–ª–æ —Ä–∞–≤–Ω–æ 40")
end

-- –¶–∏–∫–ª—ã
for i = 1, 5 do
    print("–ò—Ç–µ—Ä–∞—Ü–∏—è " .. i)
end

local j = 0
while j < 3 do
    print("While: " .. j)
    j = j + 1
end

-- –§—É–Ω–∫—Ü–∏–∏
function greet(name)
    return "–ü—Ä–∏–≤–µ—Ç, " .. name .. "!"
end

print(greet("–ê–Ω–∂–µ–ª–∞"))`,
                    functions: `-- –§—É–Ω–∫—Ü–∏–∏ –≤ Lua
-- –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
function add(a, b)
    return a + b
end

-- –ê–Ω–æ–Ω–∏–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ª—è–º–±–¥—ã)
local multiply = function(a, b) 
    return a * b 
end

-- –§—É–Ω–∫—Ü–∏–∏ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º —á–∏—Å–ª–æ–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
function sum(...)
    local result = 0
    for i, v in ipairs({...}) do
        result = result + v
    end
    return result
end

-- –í–æ–∑–≤—Ä–∞—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
function minmax(a, b)
    if a < b then
        return a, b
    else
        return b, a
    end
end

local min, max = minmax(10, 5)
print("Min:", min, "Max:", max)`,
                    tables: `-- –¢–∞–±–ª–∏—Ü—ã –≤ Lua (–∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã)
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
local person = {
    name = "–ê–Ω–∂–µ–ª–∞",
    age = 25,
    skills = {"Lua", "AI", "–û–±—É—á–µ–Ω–∏–µ"}
}

-- –î–æ—Å—Ç—É–ø –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º
print(person.name) -- –ê–Ω–∂–µ–ª–∞
print(person["age"]) -- 25

-- –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ —Ç–∞–±–ª–∏—Ü–µ
for key, value in pairs(person) do
    if type(value) == "table" then
        print(key .. ": " .. table.concat(value, ", "))
    else
        print(key .. ": " .. value)
    end
end

-- –ú–∞—Å—Å–∏–≤—ã (—Å–ø–∏—Å–∫–∏)
local colors = {"–∫—Ä–∞—Å–Ω—ã–π", "–∑–µ–ª–µ–Ω—ã–π", "—Å–∏–Ω–∏–π"}
for i, color in ipairs(colors) do
    print(i, color)
end`
                },
                'python': {
                    description: "Python - —ç—Ç–æ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è."
                },
                'javascript': {
                    description: "JavaScript - —ç—Ç–æ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü."
                }
            },
            games: {
                'goday': {
                    levels: {
                        description: "–í GoDAY 15 —É—Ä–æ–≤–Ω–µ–π —Å –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é: –Ω–∞—á–∞–ª—å–Ω—ã–µ (1-5), —Å—Ä–µ–¥–Ω–∏–µ (6-10) –∏ —Å–ª–æ–∂–Ω—ã–µ (11-15).",
                        details: {
                            1: "–£—Ä–æ–≤–µ–Ω—å 1: –û–±—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é. –°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ.",
                            2: "–£—Ä–æ–≤–µ–Ω—å 2: –ü–µ—Ä–≤—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è. –£—á–∏—Ç–µ—Å—å –ø—Ä—ã–≥–∞—Ç—å —á–µ—Ä–µ–∑ —è–º—ã.",
                            15: "–£—Ä–æ–≤–µ–Ω—å 15: –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å–µ –Ω–∞–≤—ã–∫–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –≤ –∏–≥—Ä–µ."
                        }
                    },
                    tips: "–°–æ–≤–µ—Ç—ã –ø–æ GoDAY: 1) –ò–∑—É—á–∞–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤—Ä–∞–≥–æ–≤ 2) –ö–æ–ø–∏—Ç–µ —Ä–µ—Å—É—Ä—Å—ã 3) –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è",
                    secrets: "–°–µ–∫—Ä–µ—Ç—ã GoDAY: 1) –ù–∞ 3 —É—Ä–æ–≤–Ω–µ –ø—Ä—ã–≥–Ω–∏—Ç–µ 3 —Ä–∞–∑–∞ —É –ª–µ–≤–æ–π —Å—Ç–µ–Ω—ã 2) –ù–∞ 7 —É—Ä–æ–≤–Ω–µ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –∫–Ω–æ–ø–∫–∏"
                },
                'russia stars': {
                    creator: "Russia Stars —Å–æ–∑–¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–æ–π –ø–æ–¥ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –°–µ—Ä–≥–µ—è –®–∏—Ä–æ–∫–æ–≤–∞.",
                    tips: "–°–æ–≤–µ—Ç—ã: 1) –£—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ —Å–æ–±—ã—Ç–∏—è—Ö 2) –í—Å—Ç—É–ø–∞–π—Ç–µ –≤ –∫–ª–∞–Ω—ã 3) –£–ª—É—á—à–∞–π—Ç–µ –Ω–∞–≤—ã–∫–∏"
                }
            },
            technology: {
                '–∏–∏': {
                    description: "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç - —ç—Ç–æ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –º–∞—à–∏–Ω–∞–º–∏.",
                    examples: "–ü—Ä–∏–º–µ—Ä—ã –ò–ò: 1) –ù–µ–π—Ä–æ—Å–µ—Ç–∏ 2) –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ 3) –û–±—Ä–∞–±–æ—Ç–∫–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞"
                },
                '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': {
                    languages: "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —è–∑—ã–∫–∏: Python, JavaScript, Java, C++, C#",
                    advice: "–°–æ–≤–µ—Ç—ã –ø–æ –æ–±—É—á–µ–Ω–∏—é: 1) –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ 2) –†–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ 3) –ò–∑—É—á–∞–π—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã"
                }
            },
            personal: {
                '—Å–æ–≤–µ—Ç': {
                    general: "–ú–æ–π —Å–æ–≤–µ—Ç: —Ä–∞–∑–±–∏–≤–∞–π—Ç–µ –±–æ–ª—å—à–∏–µ —Ü–µ–ª–∏ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –∏ –¥–µ–ª–∞–π—Ç–µ –∏—Ö —Ä–µ–≥—É–ª—è—Ä–Ω–æ.",
                    work: "–î–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: 1) –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç 2) –î–µ–ª–∞–π—Ç–µ –ø–µ—Ä–µ—Ä—ã–≤—ã 3) –§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ"
                },
                '–º–æ—Ç–∏–≤–∞—Ü–∏—è': {
                    tips: "–ö–∞–∫ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ–±—è: 1) –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ—é —Ü–µ–ª—å 2) –í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —É—Å–ø–µ—Ö 3) –û—Ç–º–µ—á–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å"
                }
            },
            tools: {
                '–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π': {
                    description: "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏. –í—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –¥–ª–∏–Ω—É –∏ –∫–∞–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.",
                    example: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å 12 —Å–∏–º–≤–æ–ª–æ–≤ —Å —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏"
                },
                'qr –∫–æ–¥': {
                    description: "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ URL, –∏ —è —Å–æ–∑–¥–∞–º QR-–∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å.",
                    example: "–°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥ –¥–ª—è https://example.com"
                },
                '–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç': {
                    description: "–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –∫—É—Ä—Å–∞–º–∏. –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –∏ –≤–∞–ª—é—Ç—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.",
                    example: "–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å 100 USD –≤ RUB"
                },
                '—Ü–≤–µ—Ç–æ–≤–æ–π –∫–æ–¥': {
                    description: "–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ü–≤–µ—Ç–æ–≤—ã—Ö –∫–æ–¥–æ–≤ –º–µ–∂–¥—É HEX, RGB –∏ HSL —Ñ–æ—Ä–º–∞—Ç–∞–º–∏.",
                    example: "–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å #6c5ce7 –≤ RGB"
                },
                '–∑–∞–º–µ—Ç–∫–∏': {
                    description: "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.",
                    example: "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É '–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ'"
                },
                '—Ç–∞–π–º–µ—Ä': {
                    description: "–¢–∞–π–º–µ—Ä —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—Å–∫–∞, –ø–∞—É–∑—ã –∏ —Å–±—Ä–æ—Å–∞.",
                    example: "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç"
                },
                '–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä': {
                    description: "–ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.",
                    example: "–ü–æ—Å—á–∏—Ç–∞—Ç—å 45 * 3.14"
                },
                '—Ñ–∞–π–ª—ã': {
                    description: "–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ (TXT), –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ HTML.",
                    example: "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –∑–∞–º–µ—Ç–∫–∞–º–∏"
                },
                '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏': {
                    description: "–°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≤—Å–µ–º.",
                    example: "–ú–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏"
                }
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞
        function initSpeechSynthesis() {
            if (!speechSynthesis) {
                console.warn('Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                addStatusMessage('–û–∑–≤—É—á–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                dialogState.speechSettings.enabled = false;
                return;
            }

            function loadVoices() {
                voices = speechSynthesis.getVoices();
                const russianVoices = voices.filter(voice => voice.lang.includes('ru') || voice.lang.includes('RU') || voice.name.includes('Russian') || voice.name.includes('russian'));
                
                if (russianVoices.length > 0) {
                    dialogState.speechSettings.voice = russianVoices[0];
                } else if (voices.length > 0) {
                    dialogState.speechSettings.voice = voices[0];
                }

                if (voices.length === 0) {
                    setTimeout(loadVoices, 1000);
                }
            }

            speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();

            if (speechSynthesis) {
                addStatusMessage('–û–∑–≤—É—á–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
            }
        }

        // –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        function speakText(text) {
            if (!dialogState.speechSettings.enabled || !speechSynthesis) return;
            
            speechSynthesis.cancel();
            speechUtterance = new SpeechSynthesisUtterance(text);
            speechUtterance.voice = dialogState.speechSettings.voice;
            speechUtterance.rate = dialogState.speechSettings.rate;
            speechUtterance.pitch = dialogState.speechSettings.pitch;
            speechUtterance.volume = dialogState.speechSettings.volume;
            speechUtterance.lang = 'ru-RU';

            speechUtterance.onstart = function() {
                console.log('–ù–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
            };
            speechUtterance.onend = function() {
                console.log('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
            };
            speechUtterance.onerror = function(event) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', event.error);
            };

            speechSynthesis.speak(speechUtterance);
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        function stopSpeech() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        function toggleDarkMode() {
            dialogState.darkMode = !dialogState.darkMode;
            localStorage.setItem('darkMode', dialogState.darkMode);
            
            if (dialogState.darkMode) {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.textContent = 'üåô';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ª–∏–º–∏—Ç–∞
        function updateLimitCounter() {
            const now = Date.now();
            const requestData = JSON.parse(localStorage.getItem('requestData')) || { count: 0, firstRequestTime: now };
            
            if (now - requestData.firstRequestTime > HOUR_IN_MS) {
                requestData.count = 0;
                requestData.firstRequestTime = now;
                localStorage.setItem('requestData', JSON.stringify(requestData));
            }

            const remaining = REQUEST_LIMIT - requestData.count;
            const timeLeftMs = HOUR_IN_MS - (now - requestData.firstRequestTime);
            const timeLeftMin = Math.ceil(timeLeftMs / (60 * 1000));

            limitCounter.className = 'limit-counter';
            if (remaining <= 10) {
                limitCounter.classList.add(remaining <= 3 ? 'error' : 'warning');
            }
            limitCounter.textContent = `–õ–∏–º–∏—Ç: ${remaining}/${REQUEST_LIMIT} (—Å–±—Ä–æ—Å —á–µ—Ä–µ–∑ ${timeLeftMin} –º–∏–Ω)`;
            return remaining;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
        function checkRequestLimit() {
            const now = Date.now();
            const requestData = JSON.parse(localStorage.getItem('requestData')) || { count: 0, firstRequestTime: now };

            if (now - requestData.firstRequestTime > HOUR_IN_MS) {
                requestData.count = 1;
                requestData.firstRequestTime = now;
                localStorage.setItem('requestData', JSON.stringify(requestData));
                updateLimitCounter();
                return true;
            }

            if (requestData.count >= REQUEST_LIMIT) {
                const timeLeft = Math.ceil((HOUR_IN_MS - (now - requestData.firstRequestTime)) / (60 * 1000));
                addLimitMessage(`–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (${REQUEST_LIMIT} –≤ —á–∞—Å). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ ${timeLeft} –º–∏–Ω—É—Ç.`);
                updateLimitCounter();
                return false;
            }

            requestData.count++;
            localStorage.setItem('requestData', JSON.stringify(requestData));
            updateLimitCounter();
            return true;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        function adjustTextareaHeight() {
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
            
            if (userInput.scrollHeight > 120) {
                userInput.style.overflowY = 'auto';
            } else {
                userInput.style.overflowY = 'hidden';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        userInput.addEventListener('input', adjustTextareaHeight);
        adjustTextareaHeight();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ Firebase
        async function firebaseRequest(method, path, data = null) {
            try {
                const url = `${FIREBASE_URL}${path}`;
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                if (data) {
                    options.body = JSON.stringify(data);
                }
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ Firebase: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Firebase:', error);
                addStatusMessage(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ${error.message}`);
                return null;
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –∏–∑ Firebase
        async function loadLearnedData() {
            addStatusMessage("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...");
            try {
                const data = await firebaseRequest('GET', KNOWLEDGE_PATH);
                if (data) {
                    for (const category in data) {
                        if (!knowledgeBase[category]) {
                            knowledgeBase[category] = {};
                        }
                        for (const topic in data[category]) {
                            knowledgeBase[category][topic] = {
                                ...(knowledgeBase[category][topic] || {}),
                                ...data[category][topic]
                            };
                        }
                    }
                    addStatusMessage("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞");
                } else {
                    addStatusMessage("–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–Ω–∞–Ω–∏–π:", error);
                addStatusMessage("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞");
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ Firebase
        async function loadCustomFunctions() {
            try {
                const data = await firebaseRequest('GET', CUSTOM_FUNCTIONS_PATH);
                if (data) {
                    dialogState.customFunctions = data;
                    addStatusMessage("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π:", error);
                addStatusMessage("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π");
            }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è –≤ Firebase
        async function saveLearnedData() {
            try {
                const userData = {};
                for (const category in knowledgeBase) {
                    userData[category] = {};
                    for (const topic in knowledgeBase[category]) {
                        const topicData = knowledgeBase[category][topic];
                        userData[category][topic] = {};
                        for (const key in topicData) {
                            if (key.startsWith('user_')) {
                                userData[category][topic][key] = topicData[key];
                            }
                        }
                        if (Object.keys(userData[category][topic]).length === 0) {
                            delete userData[category][topic];
                        }
                    }
                    if (Object.keys(userData[category]).length === 0) {
                        delete userData[category];
                    }
                }
                if (Object.keys(userData).length > 0) {
                    addStatusMessage("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...");
                    await firebaseRequest('PATCH', KNOWLEDGE_PATH, userData);
                    addStatusMessage("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π:", error);
                addStatusMessage("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ");
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
        function addStatusMessage(message) {
            const statusElement = document.createElement('div');
            statusElement.className = 'status-message';
            statusElement.textContent = message;
            chatMessages.appendChild(statusElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ª–∏–º–∏—Ç–µ
        function addLimitMessage(message) {
            const limitElement = document.createElement('div');
            limitElement.className = 'limit-message';
            limitElement.textContent = message;
            chatMessages.appendChild(limitElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        loadLearnedData();
        loadCustomFunctions();
        updateLimitCounter();
        initSpeechSynthesis();

        // –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏
        const emotionalResponses = {
            positive: ["–û—Ç–ª–∏—á–Ω–æ! üòä", "–†–∞–¥–∞ —ç—Ç–æ —Å–ª—ã—à–∞—Ç—å! ‚ú®", "–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏! üåü"],
            neutral: ["–ü–æ–Ω—è—Ç–Ω–æ.", "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ.", "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ."],
            negative: ["–ú–Ω–µ –∂–∞–ª—å —ç—Ç–æ —Å–ª—ã—à–∞—Ç—å. üòî", "–ü–æ–Ω–∏–º–∞—é –≤–∞—à–∏ —á—É–≤—Å—Ç–≤–∞.", "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–∂–Ω–æ."],
            confused: ["–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞. –£—Ç–æ—á–Ω–∏—Ç–µ?", "–ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å?", "–Ø –Ω–µ —É–≤–µ—Ä–µ–Ω–∞, —á—Ç–æ –ø–æ–Ω—è–ª–∞ –≤–æ–ø—Ä–æ—Å."]
        };

        // –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const quickReplies = {
            general: ["–ö–∞–∫ –¥–µ–ª–∞?", "–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?", "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ", "–ö–∞–∫ —Ç–µ–±—è –Ω–∞—É—á–∏—Ç—å?"],
            programming: ["–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ Lua", "–û—Å–Ω–æ–≤—ã Lua", "–§—É–Ω–∫—Ü–∏–∏ –≤ Lua", "–¢–∞–±–ª–∏—Ü—ã –≤ Lua"],
            games: ["–°–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π –≤ GoDAY?", "–ö–∞–∫ –ø—Ä–æ–π—Ç–∏ 10 —É—Ä–æ–≤–µ–Ω—å?", "–ö—Ç–æ —Å–æ–∑–¥–∞–ª Russia Stars?"],
            tech: ["–ß—Ç–æ —Ç–∞–∫–æ–µ –ò–ò?", "–ö–∞–∫ –Ω–∞—É—á–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å?", "–ö–∞–∫–∏–µ —è–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ø—É–ª—è—Ä–Ω—ã?"],
            tools: ["–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π", "–°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥", "–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç", "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª"]
        };

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        setTimeout(() => {
            addBotMessage("–ü—Ä–∏–≤–µ—Ç! –Ø –ï–ª–∏–∑–∞–≤–µ—Ç–∞ ‚Äî –≤–∞—à —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤. üòä –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –º–Ω–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã (TXT, HTML) –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, PNG) –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞. –ö–∞–∫ –º–Ω–µ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?", true);
        }, 500);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–º —Ñ–∞–π–ª–µ
            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-message';
            fileInfo.innerHTML = `<span class="file-icon">üìÑ</span> –ó–∞–≥—Ä—É–∂–∞—é —Ñ–∞–π–ª: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            chatMessages.appendChild(fileInfo);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ HTML —Ñ–∞–π–ª–æ–≤
            if (file.name.endsWith('.html') || file.name.endsWith('.htm')) {
                handleHtmlFile(file);
                return;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if (file.type.startsWith('image/')) {
                handleImageFile(file);
                return;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
            if (file.name.endsWith('.txt')) {
                handleTextFile(file);
                return;
            }

            // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
            addBotMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ TXT, HTML –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, PNG).');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ HTML —Ñ–∞–π–ª–æ–≤
        function handleHtmlFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                dialogState.currentFile = {
                    name: file.name,
                    size: file.size,
                    content: content
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                const successMsg = document.createElement('div');
                successMsg.className = 'status-message';
                successMsg.textContent = `HTML —Ñ–∞–π–ª "${file.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.`;
                chatMessages.appendChild(successMsg);

                // –°–æ–∑–¥–∞–µ–º iframe –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è HTML
                const iframeContainer = document.createElement('div');
                iframeContainer.style.marginTop = '10px';
                iframeContainer.style.border = '1px solid var(--input-border)';
                iframeContainer.style.borderRadius = '8px';
                iframeContainer.style.overflow = 'hidden';
                
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '300px';
                iframe.style.border = 'none';
                iframe.srcdoc = content;
                
                iframeContainer.appendChild(iframe);
                chatMessages.appendChild(iframeContainer);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–º
                const fileControls = document.createElement('div');
                fileControls.className = 'speech-controls';
                
                const analyzeBtn = document.createElement('button');
                analyzeBtn.className = 'speech-btn';
                analyzeBtn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
                analyzeBtn.addEventListener('click', () => analyzeHtmlContent(content));
                
                const clearBtn = document.createElement('button');
                clearBtn.className = 'speech-btn';
                clearBtn.textContent = '–û—á–∏—Å—Ç–∏—Ç—å';
                clearBtn.addEventListener('click', () => {
                    dialogState.currentFile = null;
                    iframeContainer.remove();
                    addStatusMessage('–§–∞–π–ª —É–¥–∞–ª–µ–Ω –∏–∑ –ø–∞–º—è—Ç–∏.');
                });
                
                fileControls.appendChild(analyzeBtn);
                fileControls.appendChild(clearBtn);
                chatMessages.appendChild(fileControls);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            reader.onerror = function() {
                addStatusMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ HTML —Ñ–∞–π–ª–∞.');
            };
            reader.readAsText(file);
        }

        // –ê–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ HTML —Ñ–∞–π–ª–∞
        function analyzeHtmlContent(content) {
            try {
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
                const parser = new DOMParser();
                const htmlDoc = parser.parseFromString(content, 'text/html');
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                const title = htmlDoc.title || '–ù–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞';
                const metaDescription = htmlDoc.querySelector('meta[name="description"]')?.content || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
                const h1 = htmlDoc.querySelector('h1')?.textContent || '–ù–µ—Ç H1';
                const links = htmlDoc.querySelectorAll('a');
                const images = htmlDoc.querySelectorAll('img');
                const scripts = htmlDoc.querySelectorAll('script');
                
                let response = `–ê–Ω–∞–ª–∏–∑ HTML —Ñ–∞–π–ª–∞:\n`;
                response += `- –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${title}\n`;
                response += `- –û–ø–∏—Å–∞–Ω–∏–µ: ${metaDescription}\n`;
                response += `- –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (H1): ${h1}\n`;
                response += `- –°—Å—ã–ª–æ–∫: ${links.length}\n`;
                response += `- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${images.length}\n`;
                response += `- –°–∫—Ä–∏–ø—Ç–æ–≤: ${scripts.length}\n`;
                
                // –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                const divs = htmlDoc.querySelectorAll('div');
                const sections = htmlDoc.querySelectorAll('section');
                const articles = htmlDoc.querySelectorAll('article');
                
                response += `\n–°—Ç—Ä—É–∫—Ç—É—Ä–∞:\n`;
                response += `- DIV: ${divs.length}\n`;
                response += `- SECTION: ${sections.length}\n`;
                response += `- ARTICLE: ${articles.length}\n`;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ viewport –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                const viewport = htmlDoc.querySelector('meta[name="viewport"]');
                response += `\n–ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è: ${viewport ? '–î–∞' : '–ù–µ—Ç'}\n`;
                
                addBotMessage(response);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ HTML:', error);
                addBotMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å HTML —Ñ–∞–π–ª. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏.');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (OCR)
        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                
                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const imgPreview = document.createElement('img');
                imgPreview.src = e.target.result;
                imgPreview.className = 'image-preview';
                imgPreview.style.display = 'block';
                
                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ OCR
                const progressElement = document.createElement('div');
                progressElement.className = 'ocr-progress';
                progressElement.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞...';
                
                chatMessages.appendChild(imgPreview);
                chatMessages.appendChild(progressElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Tesseract.js –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
                Tesseract.recognize(
                    img,
                    'rus+eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                progressElement.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: ${Math.round(m.progress * 100)}%`;
                            }
                        }
                    }
                ).then(({ data: { text } }) => {
                    progressElement.textContent = '–¢–µ–∫—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω!';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —á–∞—Ç
                    const textMessage = document.createElement('div');
                    textMessage.className = 'message bot-message';
                    textMessage.textContent = text.length > 0 ? text : '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.';
                    chatMessages.appendChild(textMessage);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–∫—Å—Ç–æ–º
                    const textControls = document.createElement('div');
                    textControls.className = 'speech-controls';
                    
                    const analyzeBtn = document.createElement('button');
                    analyzeBtn.className = 'speech-btn';
                    analyzeBtn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
                    analyzeBtn.addEventListener('click', () => processUserMessage(text));
                    
                    const clearBtn = document.createElement('button');
                    clearBtn.className = 'speech-btn';
                    clearBtn.textContent = '–û—á–∏—Å—Ç–∏—Ç—å';
                    clearBtn.addEventListener('click', () => {
                        imgPreview.remove();
                        textMessage.remove();
                        progressElement.remove();
                        textControls.remove();
                    });
                    
                    textControls.appendChild(analyzeBtn);
                    textControls.appendChild(clearBtn);
                    chatMessages.appendChild(textControls);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ OCR:', err);
                    progressElement.textContent = '–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞';
                });
            };
            reader.onerror = function() {
                addStatusMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
            };
            reader.readAsDataURL(file);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
        function handleTextFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                dialogState.currentFile = {
                    name: file.name,
                    size: file.size,
                    content: content
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                const successMsg = document.createElement('div');
                successMsg.className = 'status-message';
                successMsg.textContent = `–§–∞–π–ª "${file.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:`;
                chatMessages.appendChild(successMsg);

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –≤ —á–∞—Ç
                const contentMsg = document.createElement('div');
                contentMsg.className = 'message bot-message';
                contentMsg.textContent = content.length > 1000 ? content.substring(0, 1000) + '...' : content;
                chatMessages.appendChild(contentMsg);

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–º
                const fileControls = document.createElement('div');
                fileControls.className = 'speech-controls';
                
                const analyzeBtn = document.createElement('button');
                analyzeBtn.className = 'speech-btn';
                analyzeBtn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
                analyzeBtn.addEventListener('click', () => analyzeFileContent(content));
                
                const clearBtn = document.createElement('button');
                clearBtn.className = 'speech-btn';
                clearBtn.textContent = '–û—á–∏—Å—Ç–∏—Ç—å';
                clearBtn.addEventListener('click', () => {
                    dialogState.currentFile = null;
                    addStatusMessage('–§–∞–π–ª —É–¥–∞–ª–µ–Ω –∏–∑ –ø–∞–º—è—Ç–∏.');
                });
                
                fileControls.appendChild(analyzeBtn);
                fileControls.appendChild(clearBtn);
                chatMessages.appendChild(fileControls);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            reader.onerror = function() {
                addStatusMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.');
            };
            reader.readAsText(file);
        }

        // –ê–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
        function analyzeFileContent(content) {
            if (!content || content.trim() === '') {
                addBotMessage('–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞.');
                return;
            }

            // –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            const lines = content.split('\n');
            const words = content.split(/\s+/);
            const chars = content.length;

            let response = `–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞:\n`;
            response += `- –°—Ç—Ä–æ–∫: ${lines.length}\n`;
            response += `- –°–ª–æ–≤: ${words.length}\n`;
            response += `- –°–∏–º–≤–æ–ª–æ–≤: ${chars}\n\n`;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            if (content.includes('function') || content.includes('var ') || content.includes('console.log')) {
                response += '–ü–æ—Ö–æ–∂–µ –Ω–∞ –∫–æ–¥ JavaScript';
            } else if (content.includes('def ') || content.includes('import ')) {
                response += '–ü–æ—Ö–æ–∂–µ –Ω–∞ –∫–æ–¥ Python';
            } else if (content.includes('local ') || content.includes('function ')) {
                response += '–ü–æ—Ö–æ–∂–µ –Ω–∞ –∫–æ–¥ Lua';
            } else if (lines.length > 50 && words.length > 200) {
                response += '–ü–æ—Ö–æ–∂–µ –Ω–∞ –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç';
            } else {
                response += '–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ';
            }

            addBotMessage(response);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–∞
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            if (!checkRequestLimit()) {
                userInput.value = '';
                adjustTextareaHeight();
                return;
            }

            addUserMessage(message);
            userInput.value = '';
            adjustTextareaHeight();

            dialogState.context.push({ role: 'user', content: message });
            if (dialogState.context.length > 5) {
                dialogState.context.shift();
            }

            analyzeMood(message);

            typingIndicator.style.display = 'flex';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            setTimeout(() => {
                typingIndicator.style.display = 'none';
                processUserMessage(message);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 800 + Math.random() * 1200);
        }

        // –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function analyzeMood(message) {
            const lowerMessage = message.toLowerCase();
            if (/(–æ—Ç–ª–∏—á–Ω–æ|–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ|–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ|—Ä–∞–¥|—Ö–æ—Ä–æ—à–æ|—Å—É–ø–µ—Ä)/.test(lowerMessage)) {
                dialogState.userMood = 'positive';
            } else if (/(–ø–ª–æ—Ö–æ|—É–∂–∞—Å–Ω–æ|–≥—Ä—É—Å—Ç–Ω–æ|–æ–±–∏–¥–Ω–æ|—Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç)/.test(lowerMessage)) {
                dialogState.userMood = 'negative';
            } else if (/–∏–º—è|–∑–æ–≤—É—Ç|–æ–±—Ä–∞—â–∞—Ç—å—Å—è/.test(lowerMessage) && !dialogState.userName) {
                const nameMatch = message.match(/(–º–µ–Ω—è –∑–æ–≤—É—Ç|–º–æ–µ –∏–º—è|—è) ([–ê-–Ø–∞-—è–Å—ëA-Za-z]+)/i);
                if (nameMatch && nameMatch[2]) {
                    dialogState.userName = nameMatch[2];
                }
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function addUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message user-message';
            messageElement.textContent = message;
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = getCurrentTime();
            
            messageElement.appendChild(timestamp);
            chatMessages.appendChild(messageElement);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–¥–∞ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        function addBotMessage(message, showQuickReplies = false) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
            const processedMessage = message.replace(/```lua\n([\s\S]*?)```/g, function(match, code) {
                return `<div class="code-block">
                    <div class="code-header">
                        <span>Lua</span>
                        <button class="copy-code" onclick="copyToClipboard(this)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <pre>${escapeHtml(code)}</pre>
                </div>`;
            });
            
            messageElement.innerHTML = processedMessage.replace(/\n/g, '<br>');

            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = getCurrentTime();

            if (dialogState.userMood !== 'neutral') {
                const moodElement = document.createElement('div');
                moodElement.className = 'mood-indicator';
                const moodIcon = document.createElement('span');
                moodIcon.className = 'mood-icon';
                moodIcon.textContent = dialogState.userMood === 'positive' ? 'üòä' : 'üòî';
                moodElement.appendChild(moodIcon);
                moodElement.appendChild(document.createTextNode(dialogState.userMood === 'positive' ? ' –†–∞–¥–∞ –∑–∞ –≤–∞—Å!' : ' –ü–æ–Ω–∏–º–∞—é –≤–∞—Å...'));
                messageElement.appendChild(moodElement);
            }

            const speechControls = document.createElement('div');
            speechControls.className = 'speech-controls';
            
            const speakBtn = document.createElement('button');
            speakBtn.className = 'speech-btn';
            speakBtn.innerHTML = 'üîä –û–∑–≤—É—á–∏—Ç—å';
            speakBtn.addEventListener('click', () => {
                speakText(message.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
            });
            
            const stopBtn = document.createElement('button');
            stopBtn.className = 'speech-btn';
            stopBtn.innerHTML = '‚èπ –°—Ç–æ–ø';
            stopBtn.addEventListener('click', stopSpeech);
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = `speech-btn ${dialogState.speechSettings.enabled ? 'active' : ''}`;
            toggleBtn.innerHTML = dialogState.speechSettings.enabled ? 'üîà –ê–≤—Ç–æ' : 'üîá –ê–≤—Ç–æ';
            toggleBtn.addEventListener('click', () => {
                dialogState.speechSettings.enabled = !dialogState.speechSettings.enabled;
                toggleBtn.classList.toggle('active');
                toggleBtn.innerHTML = dialogState.speechSettings.enabled ? 'üîà –ê–≤—Ç–æ' : 'üîá –ê–≤—Ç–æ';
                if (dialogState.speechSettings.enabled) {
                    speakText(message.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
                } else {
                    stopSpeech();
                }
            });
            
            speechControls.appendChild(speakBtn);
            speechControls.appendChild(stopBtn);
            speechControls.appendChild(toggleBtn);
            messageElement.appendChild(speechControls);
            messageElement.appendChild(timestamp);
            chatMessages.appendChild(messageElement);

            dialogState.context.push({ role: 'bot', content: message });

            if (dialogState.speechSettings.enabled) {
                speakText(message.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
            }

            if (showQuickReplies) {
                addQuickReplies();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        window.copyToClipboard = function(button) {
            const codeBlock = button.closest('.code-block');
            const code = codeBlock.querySelector('pre').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.textContent;
                button.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                button.textContent = '–û—à–∏–±–∫–∞';
            });
        };

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        function addQuickReplies() {
            const quickRepliesContainer = document.createElement('div');
            quickRepliesContainer.className = 'quick-replies';
            let replies = [];

            if (dialogState.currentTopic) {
                if (dialogState.currentTopic.includes('lua') || dialogState.currentTopic.includes('–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä')) {
                    replies = [...quickReplies.programming];
                } else if (dialogState.currentTopic.includes('goday') || dialogState.currentTopic.includes('russia')) {
                    replies = [...quickReplies.games];
                } else if (dialogState.currentTopic.includes('–∏–∏') || dialogState.currentTopic.includes('—Ç–µ—Ö–Ω–æ–ª–æ–≥')) {
                    replies = [...quickReplies.tech];
                } else if (dialogState.currentTopic.includes('–ø–∞—Ä–æ–ª') || dialogState.currentTopic.includes('qr') || dialogState.currentTopic.includes('–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç') || dialogState.currentTopic.includes('—Ñ–∞–π–ª')) {
                    replies = [...quickReplies.tools];
                }
            }

            if (replies.length < 4) {
                replies = [...replies, ...quickReplies.general];
            }

            const shuffled = [...new Set(replies)].sort(() => 0.5 - Math.random());
            const selectedReplies = shuffled.slice(0, 4);

            selectedReplies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.className = 'quick-reply';
                replyElement.textContent = reply;
                replyElement.addEventListener('click', () => {
                    userInput.value = reply;
                    sendMessage();
                });
                quickRepliesContainer.appendChild(replyElement);
            });
            chatMessages.appendChild(quickRepliesContainer);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è
        function generatePassword(length = 12, useNumbers = true, useSymbols = true) {
            let chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (useNumbers) chars += '0123456789';
            if (useSymbols) chars += '!@#$%^&*()_+-=[]{}|;:,.<>?';
            
            let password = '';
            for (let i = 0; i < length; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return password;
        }

        // –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
        function checkPasswordStrength(password) {
            let strength = 0;
            
            // –î–ª–∏–Ω–∞
            if (password.length > 10) strength += 2;
            else if (password.length > 6) strength += 1;
            
            // –ù–∞–ª–∏—á–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
            if (/[a-z]/.test(password)) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 2;
            
            // –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã
            if (/(.)\1/.test(password)) strength -= 1;
            
            return Math.max(0, Math.min(3, strength));
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ QR-–∫–æ–¥–∞
        function generateQRCode(text, containerId = 'qr-code') {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '';
                new QRCode(container, {
                    text: text,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞
        function downloadQRCode(containerId = 'qr-code') {
            const canvas = document.querySelector(`#${containerId} canvas`);
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'qr-code.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
        function convertColor(color, fromFormat, toFormat) {
            if (fromFormat === 'hex' && toFormat === 'rgb') {
                // HEX to RGB
                const hex = color.replace('#', '');
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                return `rgb(${r}, ${g}, ${b})`;
            } else if (fromFormat === 'rgb' && toFormat === 'hex') {
                // RGB to HEX
                const rgb = color.match(/\d+/g);
                if (rgb && rgb.length === 3) {
                    const r = parseInt(rgb[0]).toString(16).padStart(2, '0');
                    const g = parseInt(rgb[1]).toString(16).padStart(2, '0');
                    const b = parseInt(rgb[2]).toString(16).padStart(2, '0');
                    return `#${r}${g}${b}`.toUpperCase();
                }
            } else if (fromFormat === 'rgb' && toFormat === 'hsl') {
                // RGB to HSL
                const rgb = color.match(/\d+/g);
                if (rgb && rgb.length === 3) {
                    let r = parseInt(rgb[0]) / 255;
                    let g = parseInt(rgb[1]) / 255;
                    let b = parseInt(rgb[2]) / 255;
                    
                    let max = Math.max(r, g, b), min = Math.min(r, g, b);
                    let h, s, l = (max + min) / 2;

                    if (max === min) {
                        h = s = 0; // achromatic
                    } else {
                        let d = max - min;
                        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                        switch (max) {
                            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                            case g: h = (b - r) / d + 2; break;
                            case b: h = (r - g) / d + 4; break;
                        }
                        h /= 6;
                    }

                    h = Math.round(h * 360);
                    s = Math.round(s * 100);
                    l = Math.round(l * 100);
                    
                    return `hsl(${h}, ${s}%, ${l}%)`;
                }
            }
            return color;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç
        function formatCurrency(amount, currency) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2
            }).format(amount);
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏
        function saveNote(noteId, content) {
            dialogState.notes[noteId] = content;
            localStorage.setItem('userNotes', JSON.stringify(dialogState.notes));
            return `–ó–∞–º–µ—Ç–∫–∞ "${noteId}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`;
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏
        function deleteNote(noteId) {
            delete dialogState.notes[noteId];
            localStorage.setItem('userNotes', JSON.stringify(dialogState.notes));
            return `–ó–∞–º–µ—Ç–∫–∞ "${noteId}" —É–¥–∞–ª–µ–Ω–∞`;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
        function updateTimerDisplay() {
            if (dialogState.timer.running) {
                const now = Date.now();
                const elapsed = dialogState.timer.elapsed + (now - dialogState.timer.startTime);
                document.getElementById('timer-display').textContent = formatTime(elapsed);
            } else {
                document.getElementById('timer-display').textContent = formatTime(dialogState.timer.elapsed);
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        function startTimer() {
            if (!dialogState.timer.running) {
                dialogState.timer.running = true;
                dialogState.timer.startTime = Date.now();
                dialogState.timer.interval = setInterval(updateTimerDisplay, 1000);
            }
        }

        // –ü–∞—É–∑–∞ —Ç–∞–π–º–µ—Ä–∞
        function pauseTimer() {
            if (dialogState.timer.running) {
                dialogState.timer.running = false;
                dialogState.timer.elapsed += Date.now() - dialogState.timer.startTime;
                clearInterval(dialogState.timer.interval);
            }
        }

        // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞
        function resetTimer() {
            dialogState.timer.running = false;
            dialogState.timer.elapsed = 0;
            dialogState.timer.startTime = 0;
            clearInterval(dialogState.timer.interval);
            document.getElementById('timer-display').textContent = formatTime(0);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è
        function createPasswordGenerator() {
            const toolHtml = `
                <div class="tool-container">
                    <div class="tool-title">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π</div>
                    <div class="tool-controls">
                        <input type="number" id="password-length" class="tool-input" value="12" min="4" max="50" placeholder="–î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è">
                        <label><input type="checkbox" id="use-numbers" checked> –¶–∏—Ñ—Ä—ã</label>
                        <label><input type="checkbox" id="use-symbols" checked> –°–∏–º–≤–æ–ª—ã</label>
                        <button id="generate-password-btn" class="tool-button">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="tool-result" id="password-result"></div>
                    <div class="password-strength">
                        <div class="strength-meter" id="strength-meter"></div>
                    </div>
                </div>
            `;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = toolHtml;
            chatMessages.appendChild(messageElement);
            
            document.getElementById('generate-password-btn').addEventListener('click', () => {
                const length = parseInt(document.getElementById('password-length').value) || 12;
                const useNumbers = document.getElementById('use-numbers').checked;
                const useSymbols = document.getElementById('use-symbols').checked;
                
                const password = generatePassword(length, useNumbers, useSymbols);
                document.getElementById('password-result').textContent = password;
                
                const strength = checkPasswordStrength(password);
                const meter = document.getElementById('strength-meter');
                meter.className = 'strength-meter';
                
                if (strength === 1) {
                    meter.classList.add('strength-weak');
                    meter.style.width = '33%';
                } else if (strength === 2) {
                    meter.classList.add('strength-medium');
                    meter.style.width = '66%';
                } else if (strength === 3) {
                    meter.classList.add('strength-strong');
                    meter.style.width = '100%';
                }
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ QR-–∫–æ–¥–∞
        function createQRGenerator() {
            const toolHtml = `
                <div class="tool-container">
                    <div class="tool-title">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–∞</div>
                    <div class="tool-controls">
                        <input type="text" id="qr-text" class="tool-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ URL">
                        <button id="generate-qr-btn" class="tool-button">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                    <div class="qr-code-container">
                        <div id="qr-code"></div>
                        <button id="download-qr-btn" class="download-btn">–°–∫–∞—á–∞—Ç—å QR-–∫–æ–¥</button>
                    </div>
                </div>
            `;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = toolHtml;
            chatMessages.appendChild(messageElement);
            
            document.getElementById('generate-qr-btn').addEventListener('click', () => {
                const text = document.getElementById('qr-text').value.trim();
                if (text) {
                    generateQRCode(text);
                }
            });
            
            document.getElementById('download-qr-btn').addEventListener('click', () => {
                downloadQRCode();
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞ –≤–∞–ª—é—Ç
        function createCurrencyConverter() {
            const currencies = {
                'USD': '–î–æ–ª–ª–∞—Ä –°–®–ê',
                'EUR': '–ï–≤—Ä–æ',
                'RUB': '–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å',
                'GBP': '–§—É–Ω—Ç —Å—Ç–µ—Ä–ª–∏–Ω–≥–æ–≤',
                'JPY': '–Ø–ø–æ–Ω—Å–∫–∞—è –π–µ–Ω–∞',
                'CNY': '–ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å'
            };
            
            let currencyOptions = '';
            for (const code in currencies) {
                currencyOptions += `<option value="${code}">${code} - ${currencies[code]}</option>`;
            }
            
            const toolHtml = `
                <div class="tool-container">
                    <div class="tool-title">–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç</div>
                    <div class="converter-row">
                        <input type="number" id="amount-from" class="converter-input" value="1" min="0" step="0.01" placeholder="–°—É–º–º–∞">
                        <select id="currency-from" class="converter-select">${currencyOptions}</select>
                    </div>
                    <div style="text-align: center; margin: 5px 0;">‚Üì</div>
                    <div class="converter-row">
                        <input type="number" id="amount-to" class="converter-input" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç" readonly>
                        <select id="currency-to" class="converter-select">${currencyOptions.replace('value="RUB"', 'value="RUB" selected')}</select>
                    </div>
                    <button id="convert-btn" class="tool-button" style="margin-top: 10px;">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <div class="status-message" id="converter-status">–ö—É—Ä—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è...</div>
                </div>
            `;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = toolHtml;
            chatMessages.appendChild(messageElement);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç (–∏–º–∏—Ç–∞—Ü–∏—è)
            setTimeout(() => {
                document.getElementById('converter-status').textContent = '–ö—É—Ä—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã (1 USD = 75 RUB, 1 EUR = 85 RUB)';
            }, 1500);
            
            document.getElementById('convert-btn').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('amount-from').value) || 0;
                const from = document.getElementById('currency-from').value;
                const to = document.getElementById('currency-to').value;
                
                // –ò–º–∏—Ç–∞—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API)
                let result;
                if (from === 'USD' && to === 'RUB') result = amount * 75;
                else if (from === 'EUR' && to === 'RUB') result = amount * 85;
                else if (from === 'RUB' && to === 'USD') result = amount / 75;
                else if (from === 'RUB' && to === 'EUR') result = amount / 85;
                else if (from === 'USD' && to === 'EUR') result = amount * 0.85;
                else if (from === 'EUR' && to === 'USD') result = amount / 0.85;
                else result = amount; // –ï—Å–ª–∏ –≤–∞–ª—é—Ç—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç –∏–ª–∏ –∫—É—Ä—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω
                
                document.getElementById('amount-to').value = result.toFixed(2);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞ —Ü–≤–µ—Ç–æ–≤
        function createColorConverter() {
            const toolHtml = `
                <div class="tool-container">
                    <div class="tool-title">–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ü–≤–µ—Ç–æ–≤</div>
                    <div class="tool-controls">
                        <input type="text" id="color-input" class="tool-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–≤–µ—Ç (hex, rgb, hsl)">
                        <select id="color-format" class="converter-select">
                            <option value="auto">–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</option>
                            <option value="hex">HEX</option>
                            <option value="rgb">RGB</option>
                            <option value="hsl">HSL</option>
                        </select>
                        <button id="convert-color-btn" class="tool-button">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="color-preview" id="color-preview"></div>
                    <div class="tool-result" id="color-result"></div>
                </div>
            `;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = toolHtml;
            chatMessages.appendChild(messageElement);
            
            document.getElementById('convert-color-btn').addEventListener('click', () => {
                const colorInput = document.getElementById('color-input').value.trim();
                const format = document.getElementById('color-format').value;
                let result = '';
                
                if (colorInput) {
                    // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞
                    let detectedFormat = format;
                    if (format === 'auto') {
                        if (colorInput.startsWith('#')) detectedFormat = 'hex';
                        else if (colorInput.startsWith('rgb')) detectedFormat = 'rgb';
                        else if (colorInput.startsWith('hsl')) detectedFormat = 'hsl';
                    }
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
                    if (detectedFormat === 'hex') {
                        const rgb = convertColor(colorInput, 'hex', 'rgb');
                        const hsl = convertColor(rgb, 'rgb', 'hsl');
                        result = `RGB: ${rgb}<br>HSL: ${hsl}`;
                        document.getElementById('color-preview').style.backgroundColor = colorInput;
                    } else if (detectedFormat === 'rgb') {
                        const hex = convertColor(colorInput, 'rgb', 'hex');
                        const hsl = convertColor(colorInput, 'rgb', 'hsl');
                        result = `HEX: ${hex}<br>HSL: ${hsl}`;
                        document.getElementById('color-preview').style.backgroundColor = colorInput;
                    } else if (detectedFormat === 'hsl') {
                        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ–ø—É—Å—Ç–∏–º HSL -> RGB -> HEX
                        result = `–ü–æ–¥–¥–µ—Ä–∂–∫–∞ HSL –≤ –¥–µ–º–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞`;
                        document.getElementById('color-preview').style.backgroundColor = 'transparent';
                    }
                    
                    document.getElementById('color-result').innerHTML = result;
                }
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∑–∞–º–µ—Ç–æ–∫
        function createNotesTool() {
            const notesList = Object.keys(dialogState.notes).length > 0 ? 
                Object.keys(dialogState.notes).map(noteId => `<option value="${noteId}">${noteId}</option>`).join('') : 
                '<option value="">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫</option>';
            
            const toolHtml = `
                <div class="tool-container">
                    <div class="tool-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏</div>
                    <div class="tool-controls">
                        <input type="text" id="note-id" class="tool-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏">
                        <select id="notes-list" class="converter-select">${notesList}</select>
                    </div>
                    <textarea id="note-content" class="note-textarea" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏"></textarea>
                    <div class="note-controls">
                        <button id="save-note-btn" class="tool-button note-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button id="delete-note-btn" class="tool-button note-clear">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = toolHtml;
            chatMessages.appendChild(messageElement);
            
            document.getElementById('notes-list').addEventListener('change', function() {
                const noteId = this.value;
                if (noteId && dialogState.notes[noteId]) {
                    document.getElementById('note-id').value = noteId;
                    document.getElementById('note-content').value = dialogState.notes[noteId];
                }
            });
            
            document.getElementById('save-note-btn').addEventListener('click', function() {
                const noteId = document.getElementById('note-id').value.trim();
                const content = document.getElementById('note-content').value.trim();
                
                if (noteId && content) {
                    saveNote(noteId, content);
                    addStatusMessage(`–ó–∞–º–µ—Ç–∫–∞ "${noteId}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫
                    const notesList = document.getElementById('notes-list');
                    notesList.innerHTML = Object.keys(dialogState.notes).map(id => 
                        `<option value="${id}">${id}</option>`
                    ).join('');
                    notesList.value = noteId;
                }
            });
            
            document.getElementById('delete-note-btn').addEventListener('click', function() {
                const noteId = document.getElementById('note-id').value.trim();
                if (noteId && dialogState.notes[noteId]) {
                    deleteNote(noteId);
                    addStatusMessage(`–ó–∞–º–µ—Ç–∫–∞ "${noteId}" —É–¥–∞–ª–µ–Ω–∞`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫
                    const notesList = document.getElementById('notes-list');
                    notesList.innerHTML = Object.keys(dialogState.notes).length > 0 ? 
                        Object.keys(dialogState.notes).map(id => `<option value="${id}">${id}</option>`).join('') : 
                        '<option value="">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫</option>';
                    
                    document.getElementById('note-id').value = '';
                    document.getElementById('note-content').value = '';
                }
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
        function createTimer() {
            const toolHtml = `
                <div class="tool-container">
                    <div class="tool-title">–¢–∞–π–º–µ—Ä</div>
                    <div class="timer-display" id="timer-display">00:00</div>
                    <div class="timer-controls">
                        <button id="start-timer-btn" class="timer-btn timer-start">–°—Ç–∞—Ä—Ç</button>
                        <button id="pause-timer-btn" class="timer-btn timer-pause">–ü–∞—É–∑–∞</button>
                        <button id="reset-timer-btn" class="timer-btn timer-reset">–°–±—Ä–æ—Å</button>
                    </div>
                </div>
            `;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = toolHtml;
            chatMessages.appendChild(messageElement);
            
            document.getElementById('start-timer-btn').addEventListener('click', startTimer);
            document.getElementById('pause-timer-btn').addEventListener('click', pauseTimer);
            document.getElementById('reset-timer-btn').addEventListener('click', resetTimer);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
        function createCalculator() {
            const toolHtml = `
                <div class="tool-container">
                    <div class="tool-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
                    <div class="calculator-display" id="calc-display">0</div>
                    <div class="calculator-buttons">
                        <button class="calc-btn calc-btn-clear" onclick="handleCalcButton('C')">C</button>
                        <button class="calc-btn" onclick="handleCalcButton('(')">(</button>
                        <button class="calc-btn" onclick="handleCalcButton(')')">)</button>
                        <button class="calc-btn calc-btn-operator" onclick="handleCalcButton('/')">/</button>
                        
                        <button class="calc-btn" onclick="handleCalcButton('7')">7</button>
                        <button class="calc-btn" onclick="handleCalcButton('8')">8</button>
                        <button class="calc-btn" onclick="handleCalcButton('9')">9</button>
                        <button class="calc-btn calc-btn-operator" onclick="handleCalcButton('*')">√ó</button>
                        
                        <button class="calc-btn" onclick="handleCalcButton('4')">4</button>
                        <button class="calc-btn" onclick="handleCalcButton('5')">5</button>
                        <button class="calc-btn" onclick="handleCalcButton('6')">6</button>
                        <button class="calc-btn calc-btn-operator" onclick="handleCalcButton('-')">-</button>
                        
                        <button class="calc-btn" onclick="handleCalcButton('1')">1</button>
                        <button class="calc-btn" onclick="handleCalcButton('2')">2</button>
                        <button class="calc-btn" onclick="handleCalcButton('3')">3</button>
                        <button class="calc-btn calc-btn-operator" onclick="handleCalcButton('+')">+</button>
                        
                        <button class="calc-btn" onclick="handleCalcButton('0')">0</button>
                        <button class="calc-btn" onclick="handleCalcButton('.')">.</button>
                        <button class="calc-btn" onclick="handleCalcButton('%')">%</button>
                        <button class="calc-btn calc-btn-equals" onclick="handleCalcButton('=')">=</button>
                    </div>
                </div>
            `;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = toolHtml;
            chatMessages.appendChild(messageElement);
            
            window.handleCalcButton = function(value) {
                const display = document.getElementById('calc-display');
                
                if (value === 'C') {
                    display.textContent = '0';
                } else if (value === '=') {
                    try {
                        display.textContent = eval(display.textContent);
                    } catch {
                        display.textContent = '–û—à–∏–±–∫–∞';
                    }
                } else {
                    if (display.textContent === '0' || display.textContent === '–û—à–∏–±–∫–∞') {
                        display.textContent = value;
                    } else {
                        display.textContent += value;
                    }
                }
            };
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
        function createCustomFunctionsTool() {
            const toolHtml = `
                <div class="custom-function-container">
                    <div class="custom-function-title">
                        <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏</span>
                        <span class="function-tag">Beta</span>
                    </div>
                    
                    <div class="custom-function-controls">
                        <input type="text" id="function-name" class="custom-function-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏">
                        <input type="text" id="function-trigger" class="custom-function-input" placeholder="–¢—Ä–∏–≥–≥–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä')">
                    </div>
                    
                    <textarea id="function-code" class="custom-function-textarea" placeholder="–ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ (JavaScript)"></textarea>
                    <textarea id="function-desc" class="custom-function-textarea" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)"></textarea>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="save-function-btn" class="custom-function-btn save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é</button>
                        <button id="test-function-btn" class="custom-function-btn">–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button id="delete-function-btn" class="custom-function-btn delete">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    
                    <div class="custom-functions-list" id="functions-list">
                        <!-- –°–ø–∏—Å–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                </div>
            `;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = toolHtml;
            chatMessages.appendChild(messageElement);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π
            renderCustomFunctionsList();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('save-function-btn').addEventListener('click', saveCustomFunction);
            document.getElementById('test-function-btn').addEventListener('click', testCustomFunction);
            document.getElementById('delete-function-btn').addEventListener('click', deleteCustomFunction);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
        function renderCustomFunctionsList() {
            const listContainer = document.getElementById('functions-list');
            if (!listContainer) return;
            
            listContainer.innerHTML = '';
            
            if (Object.keys(dialogState.customFunctions).length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: var(--timestamp-color);">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π</div>';
                return;
            }
            
            for (const [id, func] of Object.entries(dialogState.customFunctions)) {
                const functionItem = document.createElement('div');
                functionItem.className = 'custom-function-item';
                functionItem.dataset.id = id;
                
                functionItem.innerHTML = `
                    <div class="custom-function-item-title">
                        <span>${func.name}</span>
                        <small>–¢—Ä–∏–≥–≥–µ—Ä: ${func.trigger}</small>
                    </div>
                    <div class="custom-function-item-desc">${func.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                `;
                
                functionItem.addEventListener('click', () => loadCustomFunctionToForm(id));
                listContainer.appendChild(functionItem);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function loadCustomFunctionToForm(functionId) {
            const func = dialogState.customFunctions[functionId];
            if (!func) return;
            
            document.getElementById('function-name').value = func.name;
            document.getElementById('function-trigger').value = func.trigger;
            document.getElementById('function-code').value = func.code;
            document.getElementById('function-desc').value = func.description || '';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        async function saveCustomFunction() {
            const name = document.getElementById('function-name').value.trim();
            const trigger = document.getElementById('function-trigger').value.trim();
            const code = document.getElementById('function-code').value.trim();
            const description = document.getElementById('function-desc').value.trim();
            
            if (!name || !trigger || !code) {
                return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ç—Ä–∏–≥–≥–µ—Ä –∏ –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏');
            }
            
            const functionData = {
                name,
                trigger,
                code,
                description,
                createdAt: new Date().toISOString(),
                author: 'user' // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            };
            
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
                const response = await firebaseRequest('POST', CUSTOM_FUNCTIONS_PATH, functionData);
                
                if (response && response.name) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    dialogState.customFunctions[response.name] = functionData;
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('function-name').value = '';
                    document.getElementById('function-trigger').value = '';
                    document.getElementById('function-code').value = '';
                    document.getElementById('function-desc').value = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    renderCustomFunctionsList();
                    
                    addStatusMessage('–§—É–Ω–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                } else {
                    addStatusMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏:', error);
                addStatusMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏: ' + error.message);
            }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        function testCustomFunction() {
            const code = document.getElementById('function-code').value.trim();
            if (!code) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            
            try {
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const testFunc = new Function('message', 'return ' + code);
                if (typeof testFunc === 'function') {
                    const testResult = testFunc('—Ç–µ—Å—Ç');
                    alert('–§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç: ' + (testResult || '–Ω–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è'));
                } else {
                    alert('–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é!');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ —Ñ—É–Ω–∫—Ü–∏–∏: ' + error.message);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        async function deleteCustomFunction() {
            const functionId = prompt('–í–≤–µ–¥–∏—Ç–µ ID —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:');
            if (!functionId || !dialogState.customFunctions[functionId]) {
                return alert('–§—É–Ω–∫—Ü–∏—è —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                try {
                    // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
                    await firebaseRequest('DELETE', `${CUSTOM_FUNCTIONS_PATH}/${functionId}`);
                    
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    delete dialogState.customFunctions[functionId];
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    renderCustomFunctionsList();
                    
                    addStatusMessage('–§—É–Ω–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏:', error);
                    addStatusMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏: ' + error.message);
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        function handleToolCommands(message) {
            const lowerMessage = message.toLowerCase();
            let response = null;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
            for (const [id, func] of Object.entries(dialogState.customFunctions)) {
                if (lowerMessage.includes(func.trigger.toLowerCase())) {
                    try {
                        const customFunc = new Function('return ' + func.code)();
                        if (typeof customFunc === 'function') {
                            const result = customFunc(message);
                            if (result) {
                                return result;
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:', error);
                    }
                }
            }
            
            if (/(–ø–∞—Ä–æ–ª|–≥–µ–Ω–µ—Ä.*–ø–∞—Ä–æ–ª)/.test(lowerMessage)) {
                dialogState.activeTool = 'password';
                createPasswordGenerator();
                return "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –£–∫–∞–∂–∏—Ç–µ –¥–ª–∏–Ω—É –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ä–æ–ª—è.";
            }
            
            if (/(qr|–∫–æ–¥|—à—Ç—Ä–∏—Ö–∫–æ–¥)/.test(lowerMessage)) {
                dialogState.activeTool = 'qr';
                createQRGenerator();
                return "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ URL –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è.";
            }
            
            if (/(–∫–æ–Ω–≤–µ—Ä—Ç.*–≤–∞–ª—é—Ç|–≤–∞–ª—é—Ç|–∫—É—Ä—Å|—Ä—É–±–ª|–¥–æ–ª–ª–∞—Ä|–µ–≤—Ä–æ)/.test(lowerMessage)) {
                dialogState.activeTool = 'currency';
                createCurrencyConverter();
                return "–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—ã.";
            }
            
            if (/(—Ü–≤–µ—Ç|hex|rgb|hsl|–∫–æ–Ω–≤–µ—Ä—Ç.*—Ü–≤–µ—Ç)/.test(lowerMessage)) {
                dialogState.activeTool = 'color';
                createColorConverter();
                return "–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ü–≤–µ—Ç–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í–≤–µ–¥–∏—Ç–µ —Ü–≤–µ—Ç –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (HEX, RGB, HSL).";
            }
            
            if (/(–∑–∞–º–µ—Ç–∫|–∑–∞–ø–∏—Å–∫|–Ω–∞–ø–æ–º–∏–Ω–∞–Ω)/.test(lowerMessage)) {
                dialogState.activeTool = 'notes';
                createNotesTool();
                return "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞–º–µ—Ç–æ–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏.";
            }
            
            if (/(—Ç–∞–π–º–µ—Ä|—Å–µ–∫—É–Ω–¥–æ–º–µ—Ä|–≤—Ä–µ–º—è)/.test(lowerMessage)) {
                dialogState.activeTool = 'timer';
                createTimer();
                return "–¢–∞–π–º–µ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.";
            }
            
            if (/(–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä|–ø–æ—Å—á–∏—Ç–∞–π|–≤—ã—á–∏—Å–ª–∏)/.test(lowerMessage)) {
                dialogState.activeTool = 'calculator';
                createCalculator();
                return "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.";
            }
            
            if (/(—Ñ–∞–π–ª|–∑–∞–≥—Ä—É–∑–∏—Ç—å|—Ç–µ–∫—Å—Ç–æ–≤—ã–π|–¥–æ–∫—É–º–µ–Ω—Ç|–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ|—Ñ–æ—Ç–æ|–∫–∞—Ä—Ç–∏–Ω–∫–∞)/.test(lowerMessage)) {
                fileInput.click();
                return "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (TXT, HTML, JPG, PNG).";
            }
            
            if (/(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏|–º–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏|–∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è)/.test(lowerMessage)) {
                dialogState.activeTool = 'custom-functions';
                createCustomFunctionsTool();
                return "–ú–æ–¥—É–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏.";
            }
            
            if (/(–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç|—É—Ç–∏–ª–∏—Ç|–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)/.test(lowerMessage)) {
                return "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:\n" +
                    "1. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π\n" +
                    "2. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤\n" +
                    "3. –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç\n" +
                    "4. –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ü–≤–µ—Ç–æ–≤\n" +
                    "5. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏\n" +
                    "6. –¢–∞–π–º–µ—Ä\n" +
                    "7. –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä\n" +
                    "8. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (TXT, HTML, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)\n" +
                    "9. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–∏—Ö –∫–æ–º–∞–Ω–¥)\n\n" +
                    "–°–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ.";
            }
            
            return null;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –æ–±—É—á–µ–Ω–∏—è
        async function handleLearningCommands(message) {
            const lowerMessage = message.toLowerCase();

            if (/(–Ω–∞—É—á–∏|–æ–±—É—á–∏|–∑–∞–ø–æ–º–Ω–∏|–¥–æ–±–∞–≤—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)/.test(lowerMessage)) {
                dialogState.isLearningMode = true;
                return "–•–æ—Ä–æ—à–æ, —è –≥–æ—Ç–æ–≤–∞ —É—á–∏—Ç—å—Å—è! –°–∫–∞–∂–∏—Ç–µ, –∫ –∫–∞–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –Ω–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è? (–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–≥—Ä—ã, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ª–∏—á–Ω–æ–µ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)";
            }

            if (dialogState.isLearningMode) {
                if (!dialogState.learningData.category) {
                    const categoryMatch = lowerMessage.match(/(–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä|–∏–≥—Ä|—Ç–µ—Ö–Ω–æ–ª–æ–≥|–ª–∏—á–Ω|–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)/);
                    if (categoryMatch) {
                        let category;
                        if (categoryMatch[0].includes('–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä')) category = 'programming';
                        else if (categoryMatch[0].includes('–∏–≥—Ä')) category = 'games';
                        else if (categoryMatch[0].includes('—Ç–µ—Ö–Ω–æ–ª–æ–≥')) category = 'technology';
                        else if (categoryMatch[0].includes('–ª–∏—á–Ω')) category = 'personal';
                        else if (categoryMatch[0].includes('–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç')) category = 'tools';
                        
                        if (category) {
                            dialogState.learningData.category = category;
                            return `–û—Ç–ª–∏—á–Ω–æ, –∫–∞—Ç–µ–≥–æ—Ä–∏—è "${category}". –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Lua" –∏–ª–∏ "–º–æ—Ç–∏–≤–∞—Ü–∏—è")`;
                        }
                    }
                    return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–≥—Ä—ã, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ª–∏—á–Ω–æ–µ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã";
                }

                if (dialogState.learningData.category && !dialogState.learningData.topic) {
                    const topic = message.trim();
                    if (topic.length > 2) {
                        dialogState.learningData.topic = topic.toLowerCase();
                        return `–¢–µ–º–∞ "${topic}" –ø—Ä–∏–Ω—è—Ç–∞. –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ.`;
                    }
                    return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, \"Lua\" –∏–ª–∏ \"–º–æ—Ç–∏–≤–∞—Ü–∏—è\")";
                }

                if (dialogState.learningData.category && dialogState.learningData.topic) {
                    if (!knowledgeBase[dialogState.learningData.category]) {
                        knowledgeBase[dialogState.learningData.category] = {};
                    }
                    if (!knowledgeBase[dialogState.learningData.category][dialogState.learningData.topic]) {
                        knowledgeBase[dialogState.learningData.category][dialogState.learningData.topic] = {};
                    }

                    const infoKey = `user_${Date.now()}`;
                    knowledgeBase[dialogState.learningData.category][dialogState.learningData.topic][infoKey] = message;

                    await saveLearnedData();

                    const learnedCategory = dialogState.learningData.category;
                    const learnedTopic = dialogState.learningData.topic;
                    dialogState.isLearningMode = false;
                    dialogState.learningData = { category: null, topic: null };

                    const learnMsg = document.createElement('div');
                    learnMsg.className = 'learn-message';
                    learnMsg.textContent = `‚úì –ó–∞–ø–æ–º–Ω–∏–ª–∞ –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–º–µ "${learnedTopic}" –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${learnedCategory}"`;
                    chatMessages.appendChild(learnMsg);
                    
                    return "–°–ø–∞—Å–∏–±–æ! –Ø –∑–∞–ø–æ–º–Ω–∏–ª–∞ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ú–æ–≥—É —á–µ–º-—Ç–æ –µ—â–µ –ø–æ–º–æ—á—å?";
                }
            }
            return null;
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            let response = null;
            let topic = null;

            // 0. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
            for (const [id, func] of Object.entries(dialogState.customFunctions)) {
                if (lowerMessage.includes(func.trigger.toLowerCase())) {
                    try {
                        const customFunc = new Function('return ' + func.code)();
                        if (typeof customFunc === 'function') {
                            const result = customFunc(message);
                            if (result) {
                                addBotMessage(result);
                                return;
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:', error);
                    }
                }
            }

            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            response = handleToolCommands(message);
            if (response) {
                addBotMessage(response);
                return;
            }

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ –æ–±—É—á–µ–Ω–∏—è
            response = await handleLearningCommands(message);
            if (response) {
                addBotMessage(response);
                return;
            }

            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (–∏–º—è, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è)
            if (!dialogState.userName && /(–∑–æ–≤—É—Ç|–∏–º—è|–æ–±—Ä–∞—â–∞—Ç—å—Å—è)/.test(lowerMessage)) {
                const nameMatch = message.match(/(–º–µ–Ω—è –∑–æ–≤—É—Ç|–º–æ–µ –∏–º—è|—è) ([–ê-–Ø–∞-—è–Å—ëA-Za-z]+)/i);
                if (nameMatch && nameMatch[2]) {
                    dialogState.userName = nameMatch[2];
                    response = `–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ${dialogState.userName}! –¢–µ–ø–µ—Ä—å —è –±—É–¥—É –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –≤–∞–º –ø–æ –∏–º–µ–Ω–∏. –ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?`;
                } else {
                    response = "–ö–∞–∫ –º–Ω–µ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?";
                }
            } else if (dialogState.userName && /(–ø–æ–º–µ–Ω—è–π –∏–º—è|–∏–∑–º–µ–Ω–∏ –∏–º—è|—Å–º–µ–Ω–∏—Ç—å –∏–º—è)/.test(lowerMessage)) {
                response = "–ö–æ–Ω–µ—á–Ω–æ! –ö–∞–∫ –≤–∞–º —Ç–µ–ø–µ—Ä—å —É–¥–æ–±–Ω–æ, —á—Ç–æ–±—ã —è –≤–∞—Å –Ω–∞–∑—ã–≤–∞–ª–∞?";
                dialogState.userName = null;
            }

            // 4. –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            if (!response) {
                // –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ (Lua)
                if (/lua|–ª—É–∞|–∫–æ–¥|–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä|—Å–∫—Ä–∏–ø—Ç/.test(lowerMessage)) {
                    topic = 'programming';
                    if (/–ø—Ä–∏–º–µ—Ä.*–∫–æ–¥|–∫–æ–¥.*–ø—Ä–∏–º–µ—Ä|–ø–æ–∫–∞–∂–∏ –∫–æ–¥/.test(lowerMessage)) {
                        response = "–í–æ—Ç –ø—Ä–∏–º–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–æ–¥–∞ –Ω–∞ Lua:\n```lua\n-- –≠—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ Lua\nprint('–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!')\n\n-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞\nfunction factorial(n)\n    if n == 0 then\n        return 1\n    else\n        return n * factorial(n - 1)\n    end\nend\n\nprint('–§–∞–∫—Ç–æ—Ä–∏–∞–ª 5:', factorial(5))```";
                    } else if (/–æ—Å–Ω–æ–≤—ã|–±–∞–∑–æ–≤|–Ω–∞—á–∞—Ç—å|—Å–∏–Ω—Ç–∞–∫—Å–∏—Å/.test(lowerMessage)) {
                        response = "–û—Å–Ω–æ–≤—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ Lua:\n" + knowledgeBase.programming.lua.basics;
                    } else if (/—Ñ—É–Ω–∫—Ü–∏|–º–µ—Ç–æ–¥/.test(lowerMessage)) {
                        response = "–§—É–Ω–∫—Ü–∏–∏ –≤ Lua:\n" + knowledgeBase.programming.lua.functions;
                    } else if (/—Ç–∞–±–ª–∏—Ü|–º–∞—Å—Å–∏–≤|—Å–ø–∏—Å–æ–∫/.test(lowerMessage)) {
                        response = "–¢–∞–±–ª–∏—Ü—ã –≤ Lua (–∞–Ω–∞–ª–æ–≥–∏ –º–∞—Å—Å–∏–≤–æ–≤ –∏ —Å–ª–æ–≤–∞—Ä–µ–π):\n" + knowledgeBase.programming.lua.tables;
                    } else {
                        response = knowledgeBase.programming.lua.description;
                    }
                }
                // –ò–≥—Ä—ã
                else if (/goday|–∏–≥—Ä–∞|—É—Ä–æ–≤–µ–Ω—å|–≥–µ–π–º|–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ/.test(lowerMessage)) {
                    topic = 'games';
                    if (/goday.*—É—Ä–æ–≤–µ–Ω—å|—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π/.test(lowerMessage)) {
                        response = knowledgeBase.games.goday.levels.description;
                        if (/—É—Ä–æ–≤–µ–Ω—å [0-9]+/.test(lowerMessage)) {
                            const level = lowerMessage.match(/—É—Ä–æ–≤–µ–Ω—å ([0-9]+)/)[1];
                            response = knowledgeBase.games.goday.levels.details[level] || `–£—Ä–æ–≤–µ–Ω—å ${level}: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ú–æ–≥—É –¥–∞—Ç—å –æ–±—â–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—é.`;
                        }
                    } else if (/—Å–æ–≤–µ—Ç|–ø–æ–¥—Å–∫–∞–∑–∫–∞|–ø–æ–º–æ—â—å/.test(lowerMessage)) {
                        response = knowledgeBase.games.goday.tips;
                    } else if (/—Å–µ–∫—Ä–µ—Ç|–ø–∞—Å—Ö–∞–ª–∫–∞|—Ç–∞–π–Ω–∞/.test(lowerMessage)) {
                        response = knowledgeBase.games.goday.secrets;
                    } else if (/russia stars|—Ä–∞—à–∞ —Å—Ç–∞—Ä—Å/.test(lowerMessage)) {
                        if (/—Å–æ–∑–¥–∞—Ç–µ–ª—å|–∫—Ç–æ —Å–¥–µ–ª–∞–ª|–∞–≤—Ç–æ—Ä/.test(lowerMessage)) {
                            response = knowledgeBase.games['russia stars'].creator;
                        } else {
                            response = knowledgeBase.games['russia stars'].tips;
                        }
                    }
                }
                // –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
                else if (/–∏–∏|–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç|–Ω–µ–π—Ä–æ—Å–µ—Ç—å|ai/.test(lowerMessage)) {
                    topic = 'technology';
                    response = knowledgeBase.technology.–∏–∏.description;
                    if (/–ø—Ä–∏–º–µ—Ä|–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ|–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ/.test(lowerMessage)) {
                        response += "\n" + knowledgeBase.technology.–∏–∏.examples;
                    }
                }
                else if (/–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä|–∫–æ–¥|—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞|—è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä/.test(lowerMessage)) {
                    topic = 'technology';
                    if (/—è–∑—ã–∫|language/.test(lowerMessage)) {
                        response = knowledgeBase.technology.–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ.languages;
                    } else {
                        response = knowledgeBase.technology.–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ.advice;
                    }
                }
                // –õ–∏—á–Ω–æ–µ
                else if (/—Å–æ–≤–µ—Ç|—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è|–ø–æ–º–æ–≥–∏/.test(lowerMessage)) {
                    topic = 'personal';
                    if (/—Ä–∞–±–æ—Ç–∞|–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å|–¥–µ–ª–æ/.test(lowerMessage)) {
                        response = knowledgeBase.personal.—Å–æ–≤–µ—Ç.work;
                    } else {
                        response = knowledgeBase.personal.—Å–æ–≤–µ—Ç.general;
                    }
                }
                else if (/–º–æ—Ç–∏–≤–∞—Ü–∏—è|–º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å|–ª–µ–Ω—å/.test(lowerMessage)) {
                    topic = 'personal';
                    response = knowledgeBase.personal.–º–æ—Ç–∏–≤–∞—Ü–∏—è.tips;
                }
                // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
                else if (/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç|—É—Ç–∏–ª–∏—Ç|–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/.test(lowerMessage)) {
                    topic = 'tools';
                    response = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:\n" +
                        "1. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π - —Å–æ–∑–¥–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏\n" +
                        "2. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤ - –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–µ–∫—Å—Ç –≤ QR-–∫–æ–¥\n" +
                        "3. –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç - –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –º–µ–∂–¥—É –≤–∞–ª—é—Ç–∞–º–∏\n" +
                        "4. –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ü–≤–µ—Ç–æ–≤ - –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ü–≤–µ—Ç–æ–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã\n" +
                        "5. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏\n" +
                        "6. –¢–∞–π–º–µ—Ä - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è\n" +
                        "7. –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è\n" +
                        "8. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ - —Ä–∞–±–æ—Ç–∞ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ (TXT, HTML) –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏\n" +
                        "9. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–∏—Ö –∫–æ–º–∞–Ω–¥\n\n" +
                        "–°–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ.";
                }
                // –û–±—É—á–µ–Ω–∏–µ
                else if (/–∫–∞–∫ —Ç–µ–±—è –Ω–∞—É—á–∏—Ç—å|–∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è|–∫–∞–∫ –æ–±—É—á–∏—Ç—å/.test(lowerMessage)) {
                    response = "–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—É—á–∏—Ç—å –º–µ–Ω—è –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏! –ü—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏—Ç–µ:\n" +
                        "1. \"–ù–∞—É—á–∏ –º–µ–Ω—è\" –∏–ª–∏ \"–î–æ–±–∞–≤—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\"\n" +
                        "2. –£–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–≥—Ä—ã, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ª–∏—á–Ω–æ–µ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)\n" +
                        "3. –£–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É\n" +
                        "4. –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å\n\n" +
                        "–ù–∞–ø—Ä–∏–º–µ—Ä: \"–ù–∞—É—á–∏ –º–µ–Ω—è\", –∑–∞—Ç–µ–º \"–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ\", –∑–∞—Ç–µ–º \"Lua\", –∑–∞—Ç–µ–º \"Lua –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä .. –¥–ª—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫\"";
                }
                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
                else if (/—Ç–µ–º–Ω.*—Ç–µ–º–∞|—Å–≤–µ—Ç–ª.*—Ç–µ–º–∞/.test(lowerMessage)) {
                    toggleDarkMode();
                    response = dialogState.darkMode ? "–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∞ –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É. üåô" : "–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∞ –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É. ‚òÄÔ∏è";
                }
            }

            // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–Ω–∞–Ω–∏–π (–µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–∑–µ)
            if (!response) {
                for (const category in knowledgeBase) {
                    for (const topic in knowledgeBase[category]) {
                        if (lowerMessage.includes(topic.toLowerCase())) {
                            const topicData = knowledgeBase[category][topic];
                            const userKeys = Object.keys(topicData).filter(k => k.startsWith('user_'));
                            if (userKeys.length > 0) {
                                const latestKey = userKeys[userKeys.length - 1];
                                response = topicData[latestKey];
                                break;
                            }
                        }
                    }
                    if (response) break;
                }
            }

            // 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π
            if (!response) {
                if (dialogState.userMood === 'positive') {
                    const replies = emotionalResponses.positive;
                    response = replies[Math.floor(Math.random() * replies.length)];
                } else if (dialogState.userMood === 'negative') {
                    const replies = emotionalResponses.negative;
                    response = replies[Math.floor(Math.random() * replies.length)] + " –ú–æ–≥—É —á–µ–º-—Ç–æ –ø–æ–º–æ—á—å?";
                }
            }

            // 7. –û–±—â–∏–µ —Ñ—Ä–∞–∑—ã
            if (!response) {
                if (/–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|–¥–æ–±—Ä—ã–π/.test(lowerMessage)) {
                    response = dialogState.userName ? `–ü—Ä–∏–≤–µ—Ç, ${dialogState.userName}! –ß–µ–º –∑–∞–π–º—ë–º—Å—è —Å–µ–≥–æ–¥–Ω—è?` : "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?";
                } else if (/–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ —Ç—ã/.test(lowerMessage)) {
                    response = "–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏. üòä";
                } else if (/—á—Ç–æ —É–º–µ–µ—à|–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏|—Ñ—É–Ω–∫—Ü–∏–∏/.test(lowerMessage)) {
                    response = `–Ø –º–æ–≥—É:
1. –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ (Lua, Python, JavaScript)
2. –û–±—Å—É–¥–∏—Ç—å –∏–≥—Ä—ã (GoDAY, Russia Stars)
3. –û–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (–ò–ò, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)
4. –î–∞—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–ø–∞—Ä–æ–ª–∏, QR-–∫–æ–¥—ã, —Ñ–∞–π–ª—ã –∏ –¥—Ä—É–≥–∏–µ)
6. –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –±–µ—Å–µ–¥—É –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã
7. –£—á–∏—Ç—å—Å—è –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç –≤–∞—Å!
8. –í—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?`;
                } else if (/—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é/.test(lowerMessage)) {
                    response = dialogState.userName ? `–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, ${dialogState.userName}! üòä` : "–†–∞–¥–∞ –±—ã–ª–∞ –ø–æ–º–æ—á—å! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –µ—â—ë.";
                } else if (/–ø–æ–∫–∞|–¥–æ —Å–≤–∏–¥–∞–Ω|–∑–∞–≤–µ—Ä—à–∏—Ç—å/.test(lowerMessage)) {
                    response = dialogState.userName ? `–î–æ —Å–≤–∏–¥–∞–Ω–∏—è, ${dialogState.userName}! –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å, –µ—Å–ª–∏ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã. üëã` : "–î–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á! –ë—É–¥—É —Ä–∞–¥–∞ –ø–æ–º–æ—á—å —Å–Ω–æ–≤–∞.";
                }
            }

            // 8. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
            if (!response) {
                if (dialogState.context.length > 0) {
                    const lastUserMessage = dialogState.context[dialogState.context.length - 2]?.content;
                    if (lastUserMessage) {
                        if (/–¥–∞|–∫–æ–Ω–µ—á–Ω–æ|—Å–æ–≥–ª–∞—Å–µ–Ω/.test(lowerMessage)) {
                            response = "–û—Ç–ª–∏—á–Ω–æ! –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ?";
                        } else if (/–Ω–µ—Ç|–Ω–µ/.test(lowerMessage)) {
                            response = "–ü–æ–Ω—è–ª–∞. –ú–æ–∂–µ—Ç, –æ–±—Å—É–¥–∏–º —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ?";
                        }
                    }
                }

                if (!response) {
                    const lastTopicPhrase = dialogState.currentTopic ? `–í—ã —É–ø–æ–º–∏–Ω–∞–ª–∏ ${dialogState.currentTopic}. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —ç—Ç—É —Ç–µ–º—É?` : "";
                    const replies = [
                        `–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å. ${lastTopicPhrase}`,
                        "–ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å? –Ø –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞.",
                        "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –º–µ–Ω—è –Ω–µ—Ç —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ú–æ–∂–µ—Ç, –æ–±—Å—É–¥–∏–º —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ?",
                        "–Ø –≤—Å—ë –µ—â—ë —É—á—É—Å—å. –ú–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ-–¥—Ä—É–≥–æ–º—É?",
                        "–•–æ—Ç–∏—Ç–µ –Ω–∞—É—á–∏—Ç—å –º–µ–Ω—è –æ—Ç–≤–µ—Ç—É –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å? –°–∫–∞–∂–∏—Ç–µ \"–ù–∞—É—á–∏ –º–µ–Ω—è\"",
                        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω—É –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ—é!"
                    ];
                    response = replies[Math.floor(Math.random() * replies.length)];
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
            if (topic) {
                dialogState.currentTopic = topic;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É
            if (dialogState.userMood === 'positive' && !/[üòä‚ú®üåü]/.test(response)) {
                response += " üòä";
            } else if (dialogState.userMood === 'negative' && !/[üòî]/.test(response)) {
                response = "–ü–æ–Ω–∏–º–∞—é... " + response;
            }

            // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            if (dialogState.userName && !new RegExp(dialogState.userName, 'i').test(response)) {
                response = response.replace(/([.!?] )/, `, ${dialogState.userName}$1`);
            }

            // –°–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã (40% chance)
            addBotMessage(response, Math.random() < 0.4);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function getCurrentTime() {
            const now = new Date();
            return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        themeToggle.addEventListener('click', toggleDarkMode);
        fileInput.addEventListener('change', handleFileUpload);

        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            userInput.focus();
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        setInterval(updateLimitCounter, 60000);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        if ('visualViewport' in window) {
            const visualViewport = window.visualViewport;
            visualViewport.addEventListener('resize', function() {
                if (visualViewport.height < window.innerHeight) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    setTimeout(() => {
                        userInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                }
            });
        }
    </script>
</body>
</html>
