<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Анжела | AI-чат с обучением</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --dark-color: #2d3436;
            --light-color: #f5f6fa;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --error-color: #d63031;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f9f9f9;
            color: var(--dark-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh; /* Добавлено для мобильных устройств */
        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            padding: 0 5px;
        }
        
        .logo {
            font-size: clamp(1.8rem, 6vw, 2.5rem);
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo::before, .logo::after {
            content: "✦";
            margin: 0 10px;
            color: var(--accent-color);
            font-size: clamp(1.2rem, 5vw, 1.8rem);
        }
        
        .tagline {
            color: #636e72;
            font-size: clamp(0.8rem, 3vw, 1rem);
            font-weight: 500;
        }
        
        .limit-counter {
            background-color: var(--light-color);
            border-radius: 15px;
            padding: 6px 10px;
            margin: 8px auto;
            font-size: 0.75rem;
            color: var(--dark-color);
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .limit-counter.warning {
            background-color: var(--warning-color);
            color: #000;
        }
        
        .limit-counter.error {
            background-color: var(--error-color);
            color: white;
        }
        
        .chat-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            /* Добавлено для мобильных устройств */
            max-height: calc(100vh - 250px);
            min-height: 60vh;
        }
        
        .message {
            margin-bottom: 12px;
            max-width: 90%;
            padding: 12px 15px;
            border-radius: 15px;
            position: relative;
            animation: fadeIn 0.3s ease;
            line-height: 1.5;
            font-size: 0.9rem;
            word-break: break-word;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bot-message {
            background-color: var(--light-color);
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            color: var(--dark-color);
            border: 1px solid #eee;
        }
        
        .user-message {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .input-area {
            display: flex;
            gap: 8px;
            margin-top: auto;
            padding: 5px;
            align-items: center;
            /* Добавлено для мобильных устройств */
            position: sticky;
            bottom: 0;
            background-color: #f9f9f9;
            z-index: 10;
        }
        
        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 25px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s;
            background-color: white;
            min-height: 50px;
            max-height: 120px;
            resize: none;
            overflow-y: auto;
            /* Добавлено для мобильных устройств */
            -webkit-appearance: none;
            -webkit-border-radius: 25px;
        }
        
        #user-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }
        
        #send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0 20px;
            height: 50px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            /* Добавлено для мобильных устройств */
            -webkit-appearance: none;
            -webkit-border-radius: 25px;
        }
        
        #send-button:hover {
            background-color: #5a4bd1;
        }
        
        #send-button:active {
            transform: scale(0.95);
        }
        
        .typing-indicator {
            display: flex;
            padding: 12px 15px;
            background-color: var(--light-color);
            border-radius: 15px;
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            margin-bottom: 12px;
            display: none;
        }
        
        .typing-dot {
            width: 7px;
            height: 7px;
            background-color: #636e72;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        .timestamp {
            font-size: 0.65rem;
            color: #b2bec3;
            margin-top: 4px;
            text-align: right;
        }
        
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .quick-reply {
            background-color: var(--light-color);
            border: 1px solid #dfe6e9;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-reply:hover {
            background-color: #e0e0e0;
        }
        
        .quick-reply:active {
            transform: scale(0.95);
        }
        
        .mood-indicator {
            font-size: 0.75rem;
            margin-top: 4px;
            color: #636e72;
            display: flex;
            align-items: center;
        }
        
        .mood-icon {
            margin-right: 4px;
            font-size: 0.9rem;
        }
        
        .learn-message {
            font-size: 0.75rem;
            color: var(--success-color);
            margin-top: 4px;
            font-style: italic;
        }
        
        .status-message {
            font-size: 0.75rem;
            color: #636e72;
            margin-top: 4px;
            text-align: center;
            padding: 4px;
        }
        
        .limit-message {
            font-size: 0.75rem;
            color: var(--error-color);
            margin-top: 4px;
            text-align: center;
            padding: 4px;
            font-weight: 500;
        }
        
        /* Стили для кнопки озвучки */
        .speech-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .speech-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 3px 8px;
            font-size: 0.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        
        .speech-btn:hover {
            background-color: #8c7ae6;
        }
        
        .speech-btn:active {
            transform: scale(0.95);
        }
        
        .speech-btn.active {
            background-color: var(--accent-color);
        }
        
        /* Оптимизация для мобильных устройств */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
                height: auto;
                min-height: 100vh;
            }
            
            .chat-container {
                padding: 10px;
                border-radius: 12px;
                flex: 1 1 auto;
            }
            
            .chat-messages {
                max-height: calc(100vh - 220px);
                min-height: calc(100vh - 220px);
            }
            
            .message {
                max-width: 95%;
                padding: 10px 12px;
                font-size: 0.85rem;
                margin-bottom: 10px;
            }
            
            #user-input {
                padding: 10px 12px;
                font-size: 0.9rem;
                min-height: 45px;
            }
            
            #send-button {
                height: 45px;
                padding: 0 15px;
                font-size: 0.9rem;
            }
            
            .typing-indicator {
                padding: 10px 12px;
            }
            
            .quick-reply {
                padding: 5px 10px;
                font-size: 0.7rem;
            }
            
            /* Специальные стили для iOS */
            @supports (-webkit-touch-callout: none) {
                .container {
                    min-height: -webkit-fill-available;
                    height: -webkit-fill-available;
                }
                
                .chat-messages {
                    max-height: calc(100vh - 220px);
                    min-height: calc(100vh - 220px);
                }
            }
        }
        
        /* Предотвращение масштабирования на iOS */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
            
            .container {
                min-height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Анжела</div>
            <div class="tagline">Ваш AI-помощник с возможностью обучения</div>
            <div class="limit-counter" id="limit-counter"></div>
        </header>
        
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- Сообщения будут добавляться здесь -->
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <div class="input-area">
            <textarea id="user-input" placeholder="Напишите сообщение..." autocomplete="off" rows="1"></textarea>
            <button id="send-button">Отправить</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const limitCounter = document.getElementById('limit-counter');
        
        // Ограничение запросов - 50 в час
        const REQUEST_LIMIT = 50;
        const HOUR_IN_MS = 60 * 60 * 1000;
        
        // Firebase configuration
        const FIREBASE_URL = 'https://i-love-angela-default-rtdb.firebaseio.com';
        const KNOWLEDGE_PATH = '/knowledge.json';
        
        // Состояние диалога
        const dialogState = {
            context: [],
            userMood: 'neutral',
            currentTopic: null,
            lastAction: null,
            userName: null,
            isLearningMode: false,
            learningData: {
                category: null,
                topic: null
            },
            speechSettings: {
                enabled: true,
                voice: null,
                rate: 1.0,
                pitch: 1.0,
                volume: 1.0
            }
        };
        
        // Инициализация синтеза речи
        let speechSynthesis = window.speechSynthesis;
        let speechUtterance = null;
        let voices = [];
        
        // База знаний с возможностью расширения
        let knowledgeBase = {
            games: {
                'goday': {
                    levels: {
                        description: "В GoDAY 15 уровней с возрастающей сложностью: начальные (1-5), средние (6-10) и сложные (11-15).",
                        details: {
                            1: "Уровень 1: Обучение базовому управлению. Следуйте подсказкам на экране.",
                            2: "Уровень 2: Первые препятствия. Учитесь прыгать через ямы.",
                            15: "Уровень 15: Финальный босс. Используйте все навыки, полученные в игре."
                        }
                    },
                    tips: "Советы по GoDAY: 1) Изучайте паттерны врагов 2) Копите ресурсы 3) Используйте сохранения",
                    secrets: "Секреты GoDAY: 1) На 3 уровне прыгните 3 раза у левой стены 2) На 7 уровне есть скрытые кнопки"
                },
                'russia stars': {
                    creator: "Russia Stars создана командой под руководством Сергея Широкова.",
                    tips: "Советы: 1) Участвуйте в событиях 2) Вступайте в кланы 3) Улучшайте навыки"
                }
            },
            technology: {
                'ии': {
                    description: "Искусственный интеллект - это моделирование человеческого интеллекта машинами.",
                    examples: "Примеры ИИ: 1) Нейросети 2) Машинное обучение 3) Обработка естественного языка"
                },
                'программирование': {
                    languages: "Популярные языки: Python, JavaScript, Java, C++, C#",
                    advice: "Советы по обучению: 1) Практикуйтесь ежедневно 2) Работайте над реальными проектами 3) Изучайте алгоритмы"
                }
            },
            personal: {
                'совет': {
                    general: "Мой совет: разбивайте большие цели на маленькие шаги и делайте их регулярно.",
                    work: "Для продуктивности: 1) Используйте тайм-менеджмент 2) Делайте перерывы 3) Фокусируйтесь на одной задаче"
                },
                'мотивация': {
                    tips: "Как мотивировать себя: 1) Найдите свою цель 2) Визуализируйте успех 3) Отмечайте прогресс"
                }
            }
        };
        
        // Инициализация голосового синтеза
        function initSpeechSynthesis() {
            // Проверяем поддержку API
            if (!speechSynthesis) {
                console.warn('Web Speech API не поддерживается в этом браузере');
                addStatusMessage('Озвучка не поддерживается вашим браузером');
                dialogState.speechSettings.enabled = false;
                return;
            }
            
            // Загружаем голоса (некоторые браузеры требуют времени для загрузки)
            function loadVoices() {
                voices = speechSynthesis.getVoices();
                
                // Пытаемся найти русский голос
                const russianVoices = voices.filter(voice => 
                    voice.lang.includes('ru') || voice.lang.includes('RU') || 
                    voice.name.includes('Russian') || voice.name.includes('russian'));
                
                if (russianVoices.length > 0) {
                    dialogState.speechSettings.voice = russianVoices[0];
                } else if (voices.length > 0) {
                    dialogState.speechSettings.voice = voices[0];
                }
                
                // Если голоса не загрузились сразу, пробуем снова через 1 секунду
                if (voices.length === 0) {
                    setTimeout(loadVoices, 1000);
                }
            }
            
            // Слушаем событие изменения голосов
            speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
            
            // Добавляем сообщение о готовности озвучки
            if (speechSynthesis) {
                addStatusMessage('Озвучка готова к использованию');
            }
        }
        
        // Озвучивание текста
        function speakText(text) {
            if (!dialogState.speechSettings.enabled || !speechSynthesis) return;
            
            // Останавливаем текущее воспроизведение, если есть
            speechSynthesis.cancel();
            
            // Создаем новое высказывание
            speechUtterance = new SpeechSynthesisUtterance(text);
            
            // Настраиваем параметры
            speechUtterance.voice = dialogState.speechSettings.voice;
            speechUtterance.rate = dialogState.speechSettings.rate;
            speechUtterance.pitch = dialogState.speechSettings.pitch;
            speechUtterance.volume = dialogState.speechSettings.volume;
            speechUtterance.lang = 'ru-RU';
            
            // Обработчики событий
            speechUtterance.onstart = function() {
                console.log('Начало воспроизведения');
            };
            
            speechUtterance.onend = function() {
                console.log('Воспроизведение завершено');
            };
            
            speechUtterance.onerror = function(event) {
                console.error('Ошибка воспроизведения:', event.error);
            };
            
            // Запускаем воспроизведение
            speechSynthesis.speak(speechUtterance);
        }
        
        // Остановка воспроизведения
        function stopSpeech() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }
        
        // Переключение состояния озвучки
        function toggleSpeech(enabled) {
            dialogState.speechSettings.enabled = enabled;
            if (!enabled) {
                stopSpeech();
            }
            // Можно добавить сохранение состояния в localStorage
        }
        
        // Обновление счетчика лимита
        function updateLimitCounter() {
            const now = Date.now();
            const requestData = JSON.parse(localStorage.getItem('requestData')) || { 
                count: 0, 
                firstRequestTime: now 
            };
            
            // Если прошёл час, сбрасываем счётчик
            if (now - requestData.firstRequestTime > HOUR_IN_MS) {
                requestData.count = 0;
                requestData.firstRequestTime = now;
                localStorage.setItem('requestData', JSON.stringify(requestData));
            }
            
            const remaining = REQUEST_LIMIT - requestData.count;
            const timeLeftMs = HOUR_IN_MS - (now - requestData.firstRequestTime);
            const timeLeftMin = Math.ceil(timeLeftMs / (60 * 1000));
            
            // Обновляем стиль в зависимости от оставшихся запросов
            limitCounter.className = 'limit-counter';
            if (remaining <= 10) {
                limitCounter.classList.add(remaining <= 3 ? 'error' : 'warning');
            }
            
            limitCounter.textContent = `Лимит: ${remaining}/${REQUEST_LIMIT} (сброс через ${timeLeftMin} мин)`;
            
            return remaining;
        }
        
        // Функция для проверки лимита запросов
        function checkRequestLimit() {
            const now = Date.now();
            const requestData = JSON.parse(localStorage.getItem('requestData')) || { 
                count: 0, 
                firstRequestTime: now 
            };

            // Если прошёл час, сбрасываем счётчик
            if (now - requestData.firstRequestTime > HOUR_IN_MS) {
                requestData.count = 1;
                requestData.firstRequestTime = now;
                localStorage.setItem('requestData', JSON.stringify(requestData));
                updateLimitCounter();
                return true;
            }

            // Проверяем лимит
            if (requestData.count >= REQUEST_LIMIT) {
                const timeLeft = Math.ceil((HOUR_IN_MS - (now - requestData.firstRequestTime)) / (60 * 1000));
                addLimitMessage(`Вы превысили лимит запросов (${REQUEST_LIMIT} в час). Попробуйте через ${timeLeft} минут.`);
                updateLimitCounter();
                return false;
            }

            // Увеличиваем счётчик
            requestData.count++;
            localStorage.setItem('requestData', JSON.stringify(requestData));
            updateLimitCounter();
            
            return true;
        }
        
        // Автоматическое увеличение высоты textarea
        function adjustTextareaHeight() {
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
            
            // Ограничение максимальной высоты
            if (userInput.scrollHeight > 120) {
                userInput.style.overflowY = 'auto';
            } else {
                userInput.style.overflowY = 'hidden';
            }
        }
        
        // Инициализация
        userInput.addEventListener('input', adjustTextareaHeight);
        adjustTextareaHeight();
        
        // Функция для отправки запроса к Firebase
        async function firebaseRequest(method, path, data = null) {
            try {
                const url = `${FIREBASE_URL}${path}`;
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`Ошибка Firebase: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Ошибка при работе с Firebase:', error);
                addStatusMessage(`Ошибка синхронизации с сервером: ${error.message}`);
                return null;
            }
        }
        
        // Загружаем сохраненные знания из Firebase
        async function loadLearnedData() {
            addStatusMessage("Синхронизация с сервером...");
            
            try {
                const data = await firebaseRequest('GET', KNOWLEDGE_PATH);
                
                if (data) {
                    // Объединяем с существующей базой знаний
                    for (const category in data) {
                        if (!knowledgeBase[category]) {
                            knowledgeBase[category] = {};
                        }
                        for (const topic in data[category]) {
                            knowledgeBase[category][topic] = {
                                ...(knowledgeBase[category][topic] || {}),
                                ...data[category][topic]
                            };
                        }
                    }
                    addStatusMessage("Данные успешно загружены с сервера");
                } else {
                    addStatusMessage("Используются локальные данные");
                }
            } catch (error) {
                console.error("Ошибка загрузки знаний:", error);
                addStatusMessage("Ошибка загрузки данных с сервера");
            }
        }
        
        // Сохраняем новые знания в Firebase
        async function saveLearnedData() {
            try {
                // Отправляем только пользовательские данные (помеченные как user_*)
                const userData = {};
                
                for (const category in knowledgeBase) {
                    userData[category] = {};
                    
                    for (const topic in knowledgeBase[category]) {
                        const topicData = knowledgeBase[category][topic];
                        userData[category][topic] = {};
                        
                        for (const key in topicData) {
                            if (key.startsWith('user_')) {
                                userData[category][topic][key] = topicData[key];
                            }
                        }
                        
                        // Если в теме нет пользовательских данных, удаляем её из отправки
                        if (Object.keys(userData[category][topic]).length === 0) {
                            delete userData[category][topic];
                        }
                    }
                    
                    // Если в категории нет тем, удаляем её из отправки
                    if (Object.keys(userData[category]).length === 0) {
                        delete userData[category];
                    }
                }
                
                if (Object.keys(userData).length > 0) {
                    addStatusMessage("Сохранение данных на сервер...");
                    await firebaseRequest('PATCH', KNOWLEDGE_PATH, userData);
                    addStatusMessage("Данные успешно сохранены на сервере");
                }
            } catch (error) {
                console.error("Ошибка сохранения знаний:", error);
                addStatusMessage("Ошибка сохранения данных на сервере");
            }
        }
        
        // Добавляем статусное сообщение в чат
        function addStatusMessage(message) {
            const statusElement = document.createElement('div');
            statusElement.className = 'status-message';
            statusElement.textContent = message;
            chatMessages.appendChild(statusElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Добавляем сообщение о лимите
        function addLimitMessage(message) {
            const limitElement = document.createElement('div');
            limitElement.className = 'limit-message';
            limitElement.textContent = message;
            chatMessages.appendChild(limitElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Инициализация - загружаем сохраненные данные
        loadLearnedData();
        updateLimitCounter(); // Инициализация счетчика
        initSpeechSynthesis(); // Инициализация синтеза речи
        
        // Эмоциональные реакции
        const emotionalResponses = {
            positive: ["Отлично! 😊", "Рада это слышать! ✨", "Прекрасные новости! 🌟"],
            neutral: ["Понятно.", "Интересно.", "Расскажите подробнее."],
            negative: ["Мне жаль это слышать. 😔", "Понимаю ваши чувства.", "Это действительно сложно."],
            confused: ["Не совсем поняла. Уточните?", "Можете переформулировать?", "Я не уверена, что поняла вопрос."]
        };
        
        // Быстрые ответы с учетом контекста
        const quickReplies = {
            general: ["Как дела?", "Что ты умеешь?", "Расскажи о себе", "Как тебя научить?"],
            games: ["Сколько уровней в GoDAY?", "Как пройти 10 уровень?", "Кто создал Russia Stars?"],
            tech: ["Что такое ИИ?", "Как научиться программировать?", "Какие языки программирования популярны?"]
        };
        
        // Приветственное сообщение
        setTimeout(() => {
            addBotMessage("Привет! Я Анжела — ваш цифровой помощник с возможностью обучения. 😊 Вы можете не только спрашивать меня, но и учить новым вещам. Как мне к вам обращаться?", true);
        }, 500);
        
        // Отправка сообщения с проверкой лимита
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;
            
            // Проверяем лимит перед обработкой сообщения
            if (!checkRequestLimit()) {
                userInput.value = '';
                adjustTextareaHeight();
                return;
            }
            
            addUserMessage(message);
            userInput.value = '';
            adjustTextareaHeight();
            
            // Сохраняем контекст
            dialogState.context.push({ role: 'user', content: message });
            if (dialogState.context.length > 5) {
                dialogState.context.shift(); // Ограничиваем историю
            }
            
            // Анализируем настроение
            analyzeMood(message);
            
            // Показываем индикатор набора
            typingIndicator.style.display = 'flex';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Имитируем задержку ответа
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                processUserMessage(message);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 800 + Math.random() * 1200);
        }
        
        // Анализ настроения пользователя
        function analyzeMood(message) {
            const lowerMessage = message.toLowerCase();
            
            if (/(отлично|прекрасно|замечательно|рад|хорошо|супер)/.test(lowerMessage)) {
                dialogState.userMood = 'positive';
            } else if (/(плохо|ужасно|грустно|обидно|раздражает)/.test(lowerMessage)) {
                dialogState.userMood = 'negative';
            } else if (/имя|зовут|обращаться/.test(lowerMessage) && !dialogState.userName) {
                // Попытка извлечь имя из сообщения
                const nameMatch = message.match(/(меня зовут|мое имя|я) ([А-Яа-яЁёA-Za-z]+)/i);
                if (nameMatch && nameMatch[2]) {
                    dialogState.userName = nameMatch[2];
                }
            }
        }
        
        // Добавление сообщения пользователя
        function addUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message user-message';
            messageElement.textContent = message;
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = getCurrentTime();
            
            messageElement.appendChild(timestamp);
            chatMessages.appendChild(messageElement);
        }
        
        // Добавление сообщения бота
        function addBotMessage(message, showQuickReplies = false) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = message.replace(/\n/g, '<br>');
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = getCurrentTime();
            
            // Добавляем индикатор настроения
            if (dialogState.userMood !== 'neutral') {
                const moodElement = document.createElement('div');
                moodElement.className = 'mood-indicator';
                const moodIcon = document.createElement('span');
                moodIcon.className = 'mood-icon';
                moodIcon.textContent = dialogState.userMood === 'positive' ? '😊' : '😔';
                moodElement.appendChild(moodIcon);
                moodElement.appendChild(document.createTextNode(dialogState.userMood === 'positive' ? ' Рада за вас!' : ' Понимаю вас...'));
                messageElement.appendChild(moodElement);
            }
            
            // Добавляем элементы управления озвучкой
            const speechControls = document.createElement('div');
            speechControls.className = 'speech-controls';
            
            const speakBtn = document.createElement('button');
            speakBtn.className = 'speech-btn';
            speakBtn.innerHTML = '🔊 Озвучить';
            speakBtn.addEventListener('click', () => {
                speakText(message.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
            });
            
            const stopBtn = document.createElement('button');
            stopBtn.className = 'speech-btn';
            stopBtn.innerHTML = '⏹ Стоп';
            stopBtn.addEventListener('click', stopSpeech);
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = `speech-btn ${dialogState.speechSettings.enabled ? 'active' : ''}`;
            toggleBtn.innerHTML = dialogState.speechSettings.enabled ? '🔈 Авто' : '🔇 Авто';
            toggleBtn.addEventListener('click', () => {
                dialogState.speechSettings.enabled = !dialogState.speechSettings.enabled;
                toggleBtn.classList.toggle('active');
                toggleBtn.innerHTML = dialogState.speechSettings.enabled ? '🔈 Авто' : '🔇 Авто';
                
                if (dialogState.speechSettings.enabled) {
                    speakText(message.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
                } else {
                    stopSpeech();
                }
            });
            
            speechControls.appendChild(speakBtn);
            speechControls.appendChild(stopBtn);
            speechControls.appendChild(toggleBtn);
            messageElement.appendChild(speechControls);
            
            messageElement.appendChild(timestamp);
            chatMessages.appendChild(messageElement);
            
            // Сохраняем контекст
            dialogState.context.push({ role: 'bot', content: message });
            
            // Автоматически озвучиваем, если включено
            if (dialogState.speechSettings.enabled) {
                speakText(message.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
            }
            
            if (showQuickReplies) {
                addQuickReplies();
            }
        }
        
        // Добавление контекстных быстрых ответов
        function addQuickReplies() {
            const quickRepliesContainer = document.createElement('div');
            quickRepliesContainer.className = 'quick-replies';
            
            let replies = [];
            
            // Выбираем релевантные быстрые ответы
            if (dialogState.currentTopic) {
                if (dialogState.currentTopic.includes('goday') || dialogState.currentTopic.includes('russia')) {
                    replies = [...quickReplies.games];
                } else if (dialogState.currentTopic.includes('ии') || dialogState.currentTopic.includes('программир')) {
                    replies = [...quickReplies.tech];
                }
            }
            
            // Добавляем общие вопросы, если не хватает
            if (replies.length < 4) {
                replies = [...replies, ...quickReplies.general];
            }
            
            // Выбираем 4 случайных ответа
            const shuffled = [...new Set(replies)].sort(() => 0.5 - Math.random());
            const selectedReplies = shuffled.slice(0, 4);
            
            selectedReplies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.className = 'quick-reply';
                replyElement.textContent = reply;
                replyElement.addEventListener('click', () => {
                    userInput.value = reply;
                    sendMessage();
                });
                quickRepliesContainer.appendChild(replyElement);
            });
            
            chatMessages.appendChild(quickRepliesContainer);
        }
        
        // Обработка команд обучения
        async function handleLearningCommands(message) {
            const lowerMessage = message.toLowerCase();
            
            // Активация режима обучения
            if (/(научи|обучи|запомни|добавь информация)/.test(lowerMessage)) {
                dialogState.isLearningMode = true;
                return "Хорошо, я готова учиться! Скажите, к какой категории относится новая информация? (игры, технологии, личное)";
            }
            
            // Если в режиме обучения, обрабатываем поэтапно
            if (dialogState.isLearningMode) {
                // Этап 1: Определение категории
                if (!dialogState.learningData.category) {
                    const categoryMatch = lowerMessage.match(/(игр|технолог|личн)/);
                    if (categoryMatch) {
                        let category;
                        if (categoryMatch[0].includes('игр')) category = 'games';
                        else if (categoryMatch[0].includes('технолог')) category = 'technology';
                        else if (categoryMatch[0].includes('личн')) category = 'personal';
                        
                        if (category) {
                            dialogState.learningData.category = category;
                            return `Отлично, категория "${category}". Теперь укажите тему или название (например, "GoDAY" или "мотивация")`;
                        }
                    }
                    return "Пожалуйста, укажите одну из категорий: игры, технологии, личное";
                }
                
                // Этап 2: Определение темы
                if (dialogState.learningData.category && !dialogState.learningData.topic) {
                    const topic = message.trim();
                    if (topic.length > 2) {
                        dialogState.learningData.topic = topic.toLowerCase();
                        return `Тема "${topic}" принята. Теперь введите информацию, которую нужно запомнить по этой теме.`;
                    }
                    return "Пожалуйста, укажите тему или название (например, \"GoDAY\" или \"мотивация\")";
                }
                
                // Этап 3: Получение информации
                if (dialogState.learningData.category && dialogState.learningData.topic) {
                    // Создаем структуру, если ее нет
                    if (!knowledgeBase[dialogState.learningData.category]) {
                        knowledgeBase[dialogState.learningData.category] = {};
                    }
                    if (!knowledgeBase[dialogState.learningData.category][dialogState.learningData.topic]) {
                        knowledgeBase[dialogState.learningData.category][dialogState.learningData.topic] = {};
                    }
                    
                    // Добавляем информацию с текущей датой
                    const infoKey = `user_${Date.now()}`;
                    knowledgeBase[dialogState.learningData.category][dialogState.learningData.topic][infoKey] = message;
                    
                    // Сохраняем в Firebase
                    await saveLearnedData();
                    
                    // Сбрасываем режим обучения
                    const learnedCategory = dialogState.learningData.category;
                    const learnedTopic = dialogState.learningData.topic;
                    dialogState.isLearningMode = false;
                    dialogState.learningData = { category: null, topic: null };
                    
                    // Добавляем сообщение об успешном обучении
                    const learnMsg = document.createElement('div');
                    learnMsg.className = 'learn-message';
                    learnMsg.textContent = `✓ Запомнила новую информацию по теме "${learnedTopic}" в категории "${learnedCategory}"`;
                    chatMessages.appendChild(learnMsg);
                    
                    return "Спасибо! Я запомнила эту информацию. Могу чем-то еще помочь?";
                }
            }
            
            return null;
        }
        
        // Улучшенная обработка сообщения пользователя
        async function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            let response = null;
            let topic = null;
            
            // 0. Проверка команд обучения
            response = await handleLearningCommands(message);
            if (response) {
                addBotMessage(response);
                return;
            }
            
            // 1. Проверка специальных случаев (имя, приветствия)
            if (!dialogState.userName && /(зовут|имя|обращаться)/.test(lowerMessage)) {
                const nameMatch = message.match(/(меня зовут|мое имя|я) ([А-Яа-яЁёA-Za-z]+)/i);
                if (nameMatch && nameMatch[2]) {
                    dialogState.userName = nameMatch[2];
                    response = `Приятно познакомиться, ${dialogState.userName}! Теперь я буду обращаться к вам по имени. Как я могу вам помочь?`;
                } else {
                    response = "Как мне к вам обращаться?";
                }
            }
            else if (dialogState.userName && /(поменяй имя|измени имя|сменить имя)/.test(lowerMessage)) {
                response = "Конечно! Как вам теперь удобно, чтобы я вас называла?";
                dialogState.userName = null;
            }
            
            // 2. Анализ по категориям
            if (!response) {
                // Игры
                if (/goday|игра|уровень|гейм|прохождение/.test(lowerMessage)) {
                    topic = 'games';
                    if (/goday.*уровень|сколько уровней/.test(lowerMessage)) {
                        response = knowledgeBase.games.goday.levels.description;
                        if (/уровень [0-9]+/.test(lowerMessage)) {
                            const level = lowerMessage.match(/уровень ([0-9]+)/)[1];
                            response = knowledgeBase.games.goday.levels.details[level] || 
                                       `Уровень ${level}: Подробное описание недоступно. Могу дать общие советы по прохождению.`;
                        }
                    } else if (/совет|подсказка|помощь/.test(lowerMessage)) {
                        response = knowledgeBase.games.goday.tips;
                    } else if (/секрет|пасхалка|тайна/.test(lowerMessage)) {
                        response = knowledgeBase.games.goday.secrets;
                    } else if (/russia stars|раша старс/.test(lowerMessage)) {
                        if (/создатель|кто сделал|автор/.test(lowerMessage)) {
                            response = knowledgeBase.games['russia stars'].creator;
                        } else {
                            response = knowledgeBase.games['russia stars'].tips;
                        }
                    }
                }
                // Технологии
                else if (/ии|искусственный интеллект|нейросеть|ai/.test(lowerMessage)) {
                    topic = 'technology';
                    response = knowledgeBase.technology.ии.description;
                    if (/пример|применение|использование/.test(lowerMessage)) {
                        response += "\n" + knowledgeBase.technology.ии.examples;
                    }
                }
                else if (/программир|код|разработка|язык программир/.test(lowerMessage)) {
                    topic = 'technology';
                    if (/язык|language/.test(lowerMessage)) {
                        response = knowledgeBase.technology.программирование.languages;
                    } else {
                        response = knowledgeBase.technology.программирование.advice;
                    }
                }
                // Личное
                else if (/совет|рекомендация|помоги/.test(lowerMessage)) {
                    topic = 'personal';
                    if (/работа|продуктивность|дело/.test(lowerMessage)) {
                        response = knowledgeBase.personal.совет.work;
                    } else {
                        response = knowledgeBase.personal.совет.general;
                    }
                }
                else if (/мотивация|мотивировать|лень/.test(lowerMessage)) {
                    topic = 'personal';
                    response = knowledgeBase.personal.мотивация.tips;
                }
                // Обучение
                else if (/как тебя научить|как добавить информацию|как обучить/.test(lowerMessage)) {
                    response = "Вы можете научить меня новой информации! Просто скажите:\n" +
                               "1. \"Научи меня\" или \"Добавь информация\"\n" +
                               "2. Укажите категорию (игры, технологии, личное)\n" +
                               "3. Укажите тему\n" +
                               "4. Введите информацию, которую нужно запомнить\n\n" +
                               "Например: \"Научи меня\", затем \"игры\", затем \"новая игра\", затем \"Это игра про космос\"";
                }
            }
            
            // 3. Проверка пользовательских знаний (если не нашли в основной базе)
            if (!response) {
                for (const category in knowledgeBase) {
                    for (const topic in knowledgeBase[category]) {
                        // Ищем вхождение темы в сообщении
                        if (lowerMessage.includes(topic.toLowerCase())) {
                            const topicData = knowledgeBase[category][topic];
                            // Берем последнюю добавленную пользователем информацию
                            const userKeys = Object.keys(topicData).filter(k => k.startsWith('user_'));
                            if (userKeys.length > 0) {
                                const latestKey = userKeys[userKeys.length - 1];
                                response = topicData[latestKey];
                                break;
                            }
                        }
                    }
                    if (response) break;
                }
            }
            
            // 4. Обработка эмоциональных реакций
            if (!response) {
                if (dialogState.userMood === 'positive') {
                    const replies = emotionalResponses.positive;
                    response = replies[Math.floor(Math.random() * replies.length)];
                } 
                else if (dialogState.userMood === 'negative') {
                    const replies = emotionalResponses.negative;
                    response = replies[Math.floor(Math.random() * replies.length)] + " Могу чем-то помочь?";
                }
            }
            
            // 5. Общие фразы
            if (!response) {
                if (/привет|здравствуй|добрый/.test(lowerMessage)) {
                    response = dialogState.userName ? 
                              `Привет, ${dialogState.userName}! Чем займёмся сегодня?` : 
                              "Привет! Как я могу вам помочь?";
                }
                else if (/как дела|как ты/.test(lowerMessage)) {
                    response = "У меня всё отлично! Готова помочь вам с любыми вопросами. 😊";
                }
                else if (/что умеешь|возможности|функции/.test(lowerMessage)) {
                    response = `Я могу:
1. Рассказать об играх (GoDAY, Russia Stars)
2. Обсудить технологии (ИИ, программирование)
3. Дать жизненные советы
4. Поддержать беседу на разные темы
5. Учиться новой информации от вас!

Что вас интересует?`;
                }
                else if (/спасибо|благодарю/.test(lowerMessage)) {
                    response = dialogState.userName ? 
                              `Всегда пожалуйста, ${dialogState.userName}! 😊` : 
                              "Рада была помочь! Обращайтесь ещё.";
                }
                else if (/пока|до свидан|завершить/.test(lowerMessage)) {
                    response = dialogState.userName ? 
                              `До свидания, ${dialogState.userName}! Возвращайтесь, если будут вопросы. 👋` : 
                              "До новых встреч! Буду рада помочь снова.";
                }
            }
            
            // 6. Если ответ не найден, используем контекстный ответ
            if (!response) {
                // Пытаемся использовать контекст предыдущих сообщений
                if (dialogState.context.length > 0) {
                    const lastUserMessage = dialogState.context[dialogState.context.length - 2]?.content;
                    if (lastUserMessage) {
                        if (/да|конечно|согласен/.test(lowerMessage)) {
                            response = "Отлично! Что именно вас интересует в этом вопросе?";
                        } else if (/нет|не/.test(lowerMessage)) {
                            response = "Поняла. Может, обсудим что-то другое?";
                        }
                    }
                }
                
                // Если контекст не помог, используем общие фразы
                if (!response) {
                    const lastTopicPhrase = dialogState.currentTopic ? 
                        `Вы упоминали ${dialogState.currentTopic}. Хотите продолжить эту тему?` : 
                        "";
                    
                    const replies = [
                        `Не совсем поняла ваш вопрос. ${lastTopicPhrase}`,
                        "Можете переформулировать вопрос? Я не совсем поняла.",
                        "Интересный вопрос! К сожалению, у меня нет точного ответа. Может, обсудим что-то другое?",
                        "Я всё ещё учусь. Можете задать вопрос по-другому?",
                        "Хотите научить меня ответу на этот вопрос? Скажите \"Научи меня\""
                    ];
                    
                    response = replies[Math.floor(Math.random() * replies.length)];
                }
            }
            
            // Обновляем текущую тему
            if (topic) {
                dialogState.currentTopic = topic;
            }
            
            // Добавляем эмоциональную окраску
            if (dialogState.userMood === 'positive' && !/[😊✨🌟]/.test(response)) {
                response += " 😊";
            } else if (dialogState.userMood === 'negative' && !/[😔]/.test(response)) {
                response = "Понимаю... " + response;
            }
            
            // Персонализация ответа
            if (dialogState.userName && !new RegExp(dialogState.userName, 'i').test(response)) {
                response = response.replace(/([.!?] )/, `, ${dialogState.userName}$1`);
            }
            
            // Случайным образом показываем быстрые ответы (40% chance)
            addBotMessage(response, Math.random() < 0.4);
        }
        
        // Получение текущего времени
        function getCurrentTime() {
            const now = new Date();
            return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // Обработчики событий
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Фокус на поле ввода при загрузке
        window.addEventListener('load', () => {
            userInput.focus();
        });
        
        // Обновляем счетчик каждую минуту
        setInterval(updateLimitCounter, 60000);
        
        // Добавляем обработчик для виртуальной клавиатуры на мобильных устройствах
        if ('visualViewport' in window) {
            const visualViewport = window.visualViewport;
            
            visualViewport.addEventListener('resize', function() {
                // Проверяем, открыта ли клавиатура (высота viewport уменьшилась)
                if (visualViewport.height < window.innerHeight) {
                    // Прокручиваем чат вниз
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Плавно перемещаем поле ввода в видимую область
                    setTimeout(() => {
                        userInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                }
            });
        }
    </script>
</body>
</html>
