<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ê–Ω–∂–µ–ª–∞ | AI-—á–∞—Ç —Å –æ–±—É—á–µ–Ω–∏–µ–º</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --dark-color: #2d3436;
            --light-color: #f5f6fa;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --error-color: #d63031;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f9f9f9;
            color: var(--dark-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            padding: 0 5px;
        }
        
        .logo {
            font-size: clamp(1.8rem, 6vw, 2.5rem);
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo::before, .logo::after {
            content: "‚ú¶";
            margin: 0 10px;
            color: var(--accent-color);
            font-size: clamp(1.2rem, 5vw, 1.8rem);
        }
        
        .tagline {
            color: #636e72;
            font-size: clamp(0.8rem, 3vw, 1rem);
            font-weight: 500;
        }
        
        .limit-counter {
            background-color: var(--light-color);
            border-radius: 15px;
            padding: 6px 10px;
            margin: 8px auto;
            font-size: 0.75rem;
            color: var(--dark-color);
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .limit-counter.warning {
            background-color: var(--warning-color);
            color: #000;
        }
        
        .limit-counter.error {
            background-color: var(--error-color);
            color: white;
        }
        
        .chat-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
            max-height: calc(100vh - 250px);
            min-height: 60vh;
        }
        
        .message {
            margin-bottom: 12px;
            max-width: 90%;
            padding: 12px 15px;
            border-radius: 15px;
            position: relative;
            animation: fadeIn 0.3s ease;
            line-height: 1.5;
            font-size: 0.9rem;
            word-break: break-word;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bot-message {
            background-color: var(--light-color);
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            color: var(--dark-color);
            border: 1px solid #eee;
        }
        
        .user-message {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .input-area {
            display: flex;
            gap: 8px;
            margin-top: auto;
            padding: 5px;
            align-items: center;
            /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
            position: sticky;
            bottom: 0;
            background-color: #f9f9f9;
            z-index: 10;
        }
        
        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 25px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s;
            background-color: white;
            min-height: 50px;
            max-height: 120px;
            resize: none;
            overflow-y: auto;
            /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
            -webkit-appearance: none;
            -webkit-border-radius: 25px;
        }
        
        #user-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }
        
        #send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0 20px;
            height: 50px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
            -webkit-appearance: none;
            -webkit-border-radius: 25px;
        }
        
        #send-button:hover {
            background-color: #5a4bd1;
        }
        
        #send-button:active {
            transform: scale(0.95);
        }
        
        .typing-indicator {
            display: flex;
            padding: 12px 15px;
            background-color: var(--light-color);
            border-radius: 15px;
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            margin-bottom: 12px;
            display: none;
        }
        
        .typing-dot {
            width: 7px;
            height: 7px;
            background-color: #636e72;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        .timestamp {
            font-size: 0.65rem;
            color: #b2bec3;
            margin-top: 4px;
            text-align: right;
        }
        
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .quick-reply {
            background-color: var(--light-color);
            border: 1px solid #dfe6e9;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-reply:hover {
            background-color: #e0e0e0;
        }
        
        .quick-reply:active {
            transform: scale(0.95);
        }
        
        .mood-indicator {
            font-size: 0.75rem;
            margin-top: 4px;
            color: #636e72;
            display: flex;
            align-items: center;
        }
        
        .mood-icon {
            margin-right: 4px;
            font-size: 0.9rem;
        }
        
        .learn-message {
            font-size: 0.75rem;
            color: var(--success-color);
            margin-top: 4px;
            font-style: italic;
        }
        
        .status-message {
            font-size: 0.75rem;
            color: #636e72;
            margin-top: 4px;
            text-align: center;
            padding: 4px;
        }
        
        .limit-message {
            font-size: 0.75rem;
            color: var(--error-color);
            margin-top: 4px;
            text-align: center;
            padding: 4px;
            font-weight: 500;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–∑–≤—É—á–∫–∏ */
        .speech-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .speech-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 3px 8px;
            font-size: 0.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        
        .speech-btn:hover {
            background-color: #8c7ae6;
        }
        
        .speech-btn:active {
            transform: scale(0.95);
        }
        
        .speech-btn.active {
            background-color: var(--accent-color);
        }
        
        /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
                height: auto;
                min-height: 100vh;
            }
            
            .chat-container {
                padding: 10px;
                border-radius: 12px;
                flex: 1 1 auto;
            }
            
            .chat-messages {
                max-height: calc(100vh - 220px);
                min-height: calc(100vh - 220px);
            }
            
            .message {
                max-width: 95%;
                padding: 10px 12px;
                font-size: 0.85rem;
                margin-bottom: 10px;
            }
            
            #user-input {
                padding: 10px 12px;
                font-size: 0.9rem;
                min-height: 45px;
            }
            
            #send-button {
                height: 45px;
                padding: 0 15px;
                font-size: 0.9rem;
            }
            
            .typing-indicator {
                padding: 10px 12px;
            }
            
            .quick-reply {
                padding: 5px 10px;
                font-size: 0.7rem;
            }
            
            /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è iOS */
            @supports (-webkit-touch-callout: none) {
                .container {
                    min-height: -webkit-fill-available;
                    height: -webkit-fill-available;
                }
                
                .chat-messages {
                    max-height: calc(100vh - 220px);
                    min-height: calc(100vh - 220px);
                }
            }
        }
        
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ iOS */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
            
            .container {
                min-height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">–ê–Ω–∂–µ–ª–∞</div>
            <div class="tagline">–í–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ–±—É—á–µ–Ω–∏—è</div>
            <div class="limit-counter" id="limit-counter"></div>
        </header>
        
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <div class="input-area">
            <textarea id="user-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" rows="1"></textarea>
            <button id="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const limitCounter = document.getElementById('limit-counter');
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ - 50 –≤ —á–∞—Å
        const REQUEST_LIMIT = 50;
        const HOUR_IN_MS = 60 * 60 * 1000;
        
        // Firebase configuration
        const FIREBASE_URL = 'https://i-love-angela-default-rtdb.firebaseio.com';
        const KNOWLEDGE_PATH = '/knowledge.json';
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
        const dialogState = {
            context: [],
            userMood: 'neutral',
            currentTopic: null,
            lastAction: null,
            userName: null,
            isLearningMode: false,
            learningData: {
                category: null,
                topic: null
            },
            speechSettings: {
                enabled: true,
                voice: null,
                rate: 1.0,
                pitch: 1.0,
                volume: 1.0
            }
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
        let speechSynthesis = window.speechSynthesis;
        let speechUtterance = null;
        let voices = [];
        
        // –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        let knowledgeBase = {
            games: {
                'goday': {
                    levels: {
                        description: "–í GoDAY 15 —É—Ä–æ–≤–Ω–µ–π —Å –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é: –Ω–∞—á–∞–ª—å–Ω—ã–µ (1-5), —Å—Ä–µ–¥–Ω–∏–µ (6-10) –∏ —Å–ª–æ–∂–Ω—ã–µ (11-15).",
                        details: {
                            1: "–£—Ä–æ–≤–µ–Ω—å 1: –û–±—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é. –°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ.",
                            2: "–£—Ä–æ–≤–µ–Ω—å 2: –ü–µ—Ä–≤—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è. –£—á–∏—Ç–µ—Å—å –ø—Ä—ã–≥–∞—Ç—å —á–µ—Ä–µ–∑ —è–º—ã.",
                            15: "–£—Ä–æ–≤–µ–Ω—å 15: –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å–µ –Ω–∞–≤—ã–∫–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –≤ –∏–≥—Ä–µ."
                        }
                    },
                    tips: "–°–æ–≤–µ—Ç—ã –ø–æ GoDAY: 1) –ò–∑—É—á–∞–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤—Ä–∞–≥–æ–≤ 2) –ö–æ–ø–∏—Ç–µ —Ä–µ—Å—É—Ä—Å—ã 3) –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è",
                    secrets: "–°–µ–∫—Ä–µ—Ç—ã GoDAY: 1) –ù–∞ 3 —É—Ä–æ–≤–Ω–µ –ø—Ä—ã–≥–Ω–∏—Ç–µ 3 —Ä–∞–∑–∞ —É –ª–µ–≤–æ–π —Å—Ç–µ–Ω—ã 2) –ù–∞ 7 —É—Ä–æ–≤–Ω–µ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –∫–Ω–æ–ø–∫–∏"
                },
                'russia stars': {
                    creator: "Russia Stars —Å–æ–∑–¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–æ–π –ø–æ–¥ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –°–µ—Ä–≥–µ—è –®–∏—Ä–æ–∫–æ–≤–∞.",
                    tips: "–°–æ–≤–µ—Ç—ã: 1) –£—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ —Å–æ–±—ã—Ç–∏—è—Ö 2) –í—Å—Ç—É–ø–∞–π—Ç–µ –≤ –∫–ª–∞–Ω—ã 3) –£–ª—É—á—à–∞–π—Ç–µ –Ω–∞–≤—ã–∫–∏"
                }
            },
            technology: {
                '–∏–∏': {
                    description: "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç - —ç—Ç–æ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –º–∞—à–∏–Ω–∞–º–∏.",
                    examples: "–ü—Ä–∏–º–µ—Ä—ã –ò–ò: 1) –ù–µ–π—Ä–æ—Å–µ—Ç–∏ 2) –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ 3) –û–±—Ä–∞–±–æ—Ç–∫–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞"
                },
                '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': {
                    languages: "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —è–∑—ã–∫–∏: Python, JavaScript, Java, C++, C#",
                    advice: "–°–æ–≤–µ—Ç—ã –ø–æ –æ–±—É—á–µ–Ω–∏—é: 1) –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ 2) –†–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ 3) –ò–∑—É—á–∞–π—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã"
                }
            },
            personal: {
                '—Å–æ–≤–µ—Ç': {
                    general: "–ú–æ–π —Å–æ–≤–µ—Ç: —Ä–∞–∑–±–∏–≤–∞–π—Ç–µ –±–æ–ª—å—à–∏–µ —Ü–µ–ª–∏ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –∏ –¥–µ–ª–∞–π—Ç–µ –∏—Ö —Ä–µ–≥—É–ª—è—Ä–Ω–æ.",
                    work: "–î–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: 1) –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç 2) –î–µ–ª–∞–π—Ç–µ –ø–µ—Ä–µ—Ä—ã–≤—ã 3) –§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ"
                },
                '–º–æ—Ç–∏–≤–∞—Ü–∏—è': {
                    tips: "–ö–∞–∫ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ–±—è: 1) –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ—é —Ü–µ–ª—å 2) –í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —É—Å–ø–µ—Ö 3) –û—Ç–º–µ—á–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å"
                }
            }
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞
        function initSpeechSynthesis() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É API
            if (!speechSynthesis) {
                console.warn('Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                addStatusMessage('–û–∑–≤—É—á–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                dialogState.speechSettings.enabled = false;
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ–ª–æ—Å–∞ (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏)
            function loadVoices() {
                voices = speechSynthesis.getVoices();
                
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ä—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å
                const russianVoices = voices.filter(voice => 
                    voice.lang.includes('ru') || voice.lang.includes('RU') || 
                    voice.name.includes('Russian') || voice.name.includes('russian'));
                
                if (russianVoices.length > 0) {
                    dialogState.speechSettings.voice = russianVoices[0];
                } else if (voices.length > 0) {
                    dialogState.speechSettings.voice = voices[0];
                }
                
                // –ï—Å–ª–∏ –≥–æ–ª–æ—Å–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å —Å—Ä–∞–∑—É, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                if (voices.length === 0) {
                    setTimeout(loadVoices, 1000);
                }
            }
            
            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤
            speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –æ–∑–≤—É—á–∫–∏
            if (speechSynthesis) {
                addStatusMessage('–û–∑–≤—É—á–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
            }
        }
        
        // –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        function speakText(text) {
            if (!dialogState.speechSettings.enabled || !speechSynthesis) return;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
            speechSynthesis.cancel();
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–µ
            speechUtterance = new SpeechSynthesisUtterance(text);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            speechUtterance.voice = dialogState.speechSettings.voice;
            speechUtterance.rate = dialogState.speechSettings.rate;
            speechUtterance.pitch = dialogState.speechSettings.pitch;
            speechUtterance.volume = dialogState.speechSettings.volume;
            speechUtterance.lang = 'ru-RU';
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            speechUtterance.onstart = function() {
                console.log('–ù–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
            };
            
            speechUtterance.onend = function() {
                console.log('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
            };
            
            speechUtterance.onerror = function(event) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', event.error);
            };
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
            speechSynthesis.speak(speechUtterance);
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        function stopSpeech() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∑–≤—É—á–∫–∏
        function toggleSpeech(enabled) {
            dialogState.speechSettings.enabled = enabled;
            if (!enabled) {
                stopSpeech();
            }
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ localStorage
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ª–∏–º–∏—Ç–∞
        function updateLimitCounter() {
            const now = Date.now();
            const requestData = JSON.parse(localStorage.getItem('requestData')) || { 
                count: 0, 
                firstRequestTime: now 
            };
            
            // –ï—Å–ª–∏ –ø—Ä–æ—à—ë–ª —á–∞—Å, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
            if (now - requestData.firstRequestTime > HOUR_IN_MS) {
                requestData.count = 0;
                requestData.firstRequestTime = now;
                localStorage.setItem('requestData', JSON.stringify(requestData));
            }
            
            const remaining = REQUEST_LIMIT - requestData.count;
            const timeLeftMs = HOUR_IN_MS - (now - requestData.firstRequestTime);
            const timeLeftMin = Math.ceil(timeLeftMs / (60 * 1000));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤
            limitCounter.className = 'limit-counter';
            if (remaining <= 10) {
                limitCounter.classList.add(remaining <= 3 ? 'error' : 'warning');
            }
            
            limitCounter.textContent = `–õ–∏–º–∏—Ç: ${remaining}/${REQUEST_LIMIT} (—Å–±—Ä–æ—Å —á–µ—Ä–µ–∑ ${timeLeftMin} –º–∏–Ω)`;
            
            return remaining;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
        function checkRequestLimit() {
            const now = Date.now();
            const requestData = JSON.parse(localStorage.getItem('requestData')) || { 
                count: 0, 
                firstRequestTime: now 
            };

            // –ï—Å–ª–∏ –ø—Ä–æ—à—ë–ª —á–∞—Å, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
            if (now - requestData.firstRequestTime > HOUR_IN_MS) {
                requestData.count = 1;
                requestData.firstRequestTime = now;
                localStorage.setItem('requestData', JSON.stringify(requestData));
                updateLimitCounter();
                return true;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
            if (requestData.count >= REQUEST_LIMIT) {
                const timeLeft = Math.ceil((HOUR_IN_MS - (now - requestData.firstRequestTime)) / (60 * 1000));
                addLimitMessage(`–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (${REQUEST_LIMIT} –≤ —á–∞—Å). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ ${timeLeft} –º–∏–Ω—É—Ç.`);
                updateLimitCounter();
                return false;
            }

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
            requestData.count++;
            localStorage.setItem('requestData', JSON.stringify(requestData));
            updateLimitCounter();
            
            return true;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        function adjustTextareaHeight() {
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≤—ã—Å–æ—Ç—ã
            if (userInput.scrollHeight > 120) {
                userInput.style.overflowY = 'auto';
            } else {
                userInput.style.overflowY = 'hidden';
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        userInput.addEventListener('input', adjustTextareaHeight);
        adjustTextareaHeight();
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ Firebase
        async function firebaseRequest(method, path, data = null) {
            try {
                const url = `${FIREBASE_URL}${path}`;
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ Firebase: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Firebase:', error);
                addStatusMessage(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ${error.message}`);
                return null;
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –∏–∑ Firebase
        async function loadLearnedData() {
            addStatusMessage("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...");
            
            try {
                const data = await firebaseRequest('GET', KNOWLEDGE_PATH);
                
                if (data) {
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π
                    for (const category in data) {
                        if (!knowledgeBase[category]) {
                            knowledgeBase[category] = {};
                        }
                        for (const topic in data[category]) {
                            knowledgeBase[category][topic] = {
                                ...(knowledgeBase[category][topic] || {}),
                                ...data[category][topic]
                            };
                        }
                    }
                    addStatusMessage("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞");
                } else {
                    addStatusMessage("–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–Ω–∞–Ω–∏–π:", error);
                addStatusMessage("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞");
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è –≤ Firebase
        async function saveLearnedData() {
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (–ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ user_*)
                const userData = {};
                
                for (const category in knowledgeBase) {
                    userData[category] = {};
                    
                    for (const topic in knowledgeBase[category]) {
                        const topicData = knowledgeBase[category][topic];
                        userData[category][topic] = {};
                        
                        for (const key in topicData) {
                            if (key.startsWith('user_')) {
                                userData[category][topic][key] = topicData[key];
                            }
                        }
                        
                        // –ï—Å–ª–∏ –≤ —Ç–µ–º–µ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö, —É–¥–∞–ª—è–µ–º –µ—ë –∏–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏
                        if (Object.keys(userData[category][topic]).length === 0) {
                            delete userData[category][topic];
                        }
                    }
                    
                    // –ï—Å–ª–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç —Ç–µ–º, —É–¥–∞–ª—è–µ–º –µ—ë –∏–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏
                    if (Object.keys(userData[category]).length === 0) {
                        delete userData[category];
                    }
                }
                
                if (Object.keys(userData).length > 0) {
                    addStatusMessage("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...");
                    await firebaseRequest('PATCH', KNOWLEDGE_PATH, userData);
                    addStatusMessage("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π:", error);
                addStatusMessage("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ");
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
        function addStatusMessage(message) {
            const statusElement = document.createElement('div');
            statusElement.className = 'status-message';
            statusElement.textContent = message;
            chatMessages.appendChild(statusElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ª–∏–º–∏—Ç–µ
        function addLimitMessage(message) {
            const limitElement = document.createElement('div');
            limitElement.className = 'limit-message';
            limitElement.textContent = message;
            chatMessages.appendChild(limitElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        loadLearnedData();
        updateLimitCounter(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞
        initSpeechSynthesis(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
        
        // –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏
        const emotionalResponses = {
            positive: ["–û—Ç–ª–∏—á–Ω–æ! üòä", "–†–∞–¥–∞ —ç—Ç–æ —Å–ª—ã—à–∞—Ç—å! ‚ú®", "–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏! üåü"],
            neutral: ["–ü–æ–Ω—è—Ç–Ω–æ.", "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ.", "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ."],
            negative: ["–ú–Ω–µ –∂–∞–ª—å —ç—Ç–æ —Å–ª—ã—à–∞—Ç—å. üòî", "–ü–æ–Ω–∏–º–∞—é –≤–∞—à–∏ —á—É–≤—Å—Ç–≤–∞.", "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–∂–Ω–æ."],
            confused: ["–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞. –£—Ç–æ—á–Ω–∏—Ç–µ?", "–ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å?", "–Ø –Ω–µ —É–≤–µ—Ä–µ–Ω–∞, —á—Ç–æ –ø–æ–Ω—è–ª–∞ –≤–æ–ø—Ä–æ—Å."]
        };
        
        // –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const quickReplies = {
            general: ["–ö–∞–∫ –¥–µ–ª–∞?", "–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?", "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ", "–ö–∞–∫ —Ç–µ–±—è –Ω–∞—É—á–∏—Ç—å?"],
            games: ["–°–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π –≤ GoDAY?", "–ö–∞–∫ –ø—Ä–æ–π—Ç–∏ 10 —É—Ä–æ–≤–µ–Ω—å?", "–ö—Ç–æ —Å–æ–∑–¥–∞–ª Russia Stars?"],
            tech: ["–ß—Ç–æ —Ç–∞–∫–æ–µ –ò–ò?", "–ö–∞–∫ –Ω–∞—É—á–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å?", "–ö–∞–∫–∏–µ —è–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ø—É–ª—è—Ä–Ω—ã?"]
        };
        
        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        setTimeout(() => {
            addBotMessage("–ü—Ä–∏–≤–µ—Ç! –Ø –ê–Ω–∂–µ–ª–∞ ‚Äî –≤–∞—à —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ–±—É—á–µ–Ω–∏—è. üòä –í—ã –º–æ–∂–µ—Ç–µ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –º–µ–Ω—è, –Ω–æ –∏ —É—á–∏—Ç—å –Ω–æ–≤—ã–º –≤–µ—â–∞–º. –ö–∞–∫ –º–Ω–µ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?", true);
        }, 500);
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–∞
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏—è
            if (!checkRequestLimit()) {
                userInput.value = '';
                adjustTextareaHeight();
                return;
            }
            
            addUserMessage(message);
            userInput.value = '';
            adjustTextareaHeight();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            dialogState.context.push({ role: 'user', content: message });
            if (dialogState.context.length > 5) {
                dialogState.context.shift(); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            }
            
            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
            analyzeMood(message);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
            typingIndicator.style.display = 'flex';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –æ—Ç–≤–µ—Ç–∞
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                processUserMessage(message);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 800 + Math.random() * 1200);
        }
        
        // –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function analyzeMood(message) {
            const lowerMessage = message.toLowerCase();
            
            if (/(–æ—Ç–ª–∏—á–Ω–æ|–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ|–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ|—Ä–∞–¥|—Ö–æ—Ä–æ—à–æ|—Å—É–ø–µ—Ä)/.test(lowerMessage)) {
                dialogState.userMood = 'positive';
            } else if (/(–ø–ª–æ—Ö–æ|—É–∂–∞—Å–Ω–æ|–≥—Ä—É—Å—Ç–Ω–æ|–æ–±–∏–¥–Ω–æ|—Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç)/.test(lowerMessage)) {
                dialogState.userMood = 'negative';
            } else if (/–∏–º—è|–∑–æ–≤—É—Ç|–æ–±—Ä–∞—â–∞—Ç—å—Å—è/.test(lowerMessage) && !dialogState.userName) {
                // –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å –∏–º—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
                const nameMatch = message.match(/(–º–µ–Ω—è –∑–æ–≤—É—Ç|–º–æ–µ –∏–º—è|—è) ([–ê-–Ø–∞-—è–Å—ëA-Za-z]+)/i);
                if (nameMatch && nameMatch[2]) {
                    dialogState.userName = nameMatch[2];
                }
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function addUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message user-message';
            messageElement.textContent = message;
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = getCurrentTime();
            
            messageElement.appendChild(timestamp);
            chatMessages.appendChild(messageElement);
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
        function addBotMessage(message, showQuickReplies = false) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            messageElement.innerHTML = message.replace(/\n/g, '<br>');
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = getCurrentTime();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            if (dialogState.userMood !== 'neutral') {
                const moodElement = document.createElement('div');
                moodElement.className = 'mood-indicator';
                const moodIcon = document.createElement('span');
                moodIcon.className = 'mood-icon';
                moodIcon.textContent = dialogState.userMood === 'positive' ? 'üòä' : 'üòî';
                moodElement.appendChild(moodIcon);
                moodElement.appendChild(document.createTextNode(dialogState.userMood === 'positive' ? ' –†–∞–¥–∞ –∑–∞ –≤–∞—Å!' : ' –ü–æ–Ω–∏–º–∞—é –≤–∞—Å...'));
                messageElement.appendChild(moodElement);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–∑–≤—É—á–∫–æ–π
            const speechControls = document.createElement('div');
            speechControls.className = 'speech-controls';
            
            const speakBtn = document.createElement('button');
            speakBtn.className = 'speech-btn';
            speakBtn.innerHTML = 'üîä –û–∑–≤—É—á–∏—Ç—å';
            speakBtn.addEventListener('click', () => {
                speakText(message.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
            });
            
            const stopBtn = document.createElement('button');
            stopBtn.className = 'speech-btn';
            stopBtn.innerHTML = '‚èπ –°—Ç–æ–ø';
            stopBtn.addEventListener('click', stopSpeech);
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = `speech-btn ${dialogState.speechSettings.enabled ? 'active' : ''}`;
            toggleBtn.innerHTML = dialogState.speechSettings.enabled ? 'üîà –ê–≤—Ç–æ' : 'üîá –ê–≤—Ç–æ';
            toggleBtn.addEventListener('click', () => {
                dialogState.speechSettings.enabled = !dialogState.speechSettings.enabled;
                toggleBtn.classList.toggle('active');
                toggleBtn.innerHTML = dialogState.speechSettings.enabled ? 'üîà –ê–≤—Ç–æ' : 'üîá –ê–≤—Ç–æ';
                
                if (dialogState.speechSettings.enabled) {
                    speakText(message.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
                } else {
                    stopSpeech();
                }
            });
            
            speechControls.appendChild(speakBtn);
            speechControls.appendChild(stopBtn);
            speechControls.appendChild(toggleBtn);
            messageElement.appendChild(speechControls);
            
            messageElement.appendChild(timestamp);
            chatMessages.appendChild(messageElement);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            dialogState.context.push({ role: 'bot', content: message });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–∑–≤—É—á–∏–≤–∞–µ–º, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
            if (dialogState.speechSettings.enabled) {
                speakText(message.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
            }
            
            if (showQuickReplies) {
                addQuickReplies();
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        function addQuickReplies() {
            const quickRepliesContainer = document.createElement('div');
            quickRepliesContainer.className = 'quick-replies';
            
            let replies = [];
            
            // –í—ã–±–∏—Ä–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
            if (dialogState.currentTopic) {
                if (dialogState.currentTopic.includes('goday') || dialogState.currentTopic.includes('russia')) {
                    replies = [...quickReplies.games];
                } else if (dialogState.currentTopic.includes('–∏–∏') || dialogState.currentTopic.includes('–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä')) {
                    replies = [...quickReplies.tech];
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
            if (replies.length < 4) {
                replies = [...replies, ...quickReplies.general];
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º 4 —Å–ª—É—á–∞–π–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞
            const shuffled = [...new Set(replies)].sort(() => 0.5 - Math.random());
            const selectedReplies = shuffled.slice(0, 4);
            
            selectedReplies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.className = 'quick-reply';
                replyElement.textContent = reply;
                replyElement.addEventListener('click', () => {
                    userInput.value = reply;
                    sendMessage();
                });
                quickRepliesContainer.appendChild(replyElement);
            });
            
            chatMessages.appendChild(quickRepliesContainer);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –æ–±—É—á–µ–Ω–∏—è
        async function handleLearningCommands(message) {
            const lowerMessage = message.toLowerCase();
            
            // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –æ–±—É—á–µ–Ω–∏—è
            if (/(–Ω–∞—É—á–∏|–æ–±—É—á–∏|–∑–∞–ø–æ–º–Ω–∏|–¥–æ–±–∞–≤—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)/.test(lowerMessage)) {
                dialogState.isLearningMode = true;
                return "–•–æ—Ä–æ—à–æ, —è –≥–æ—Ç–æ–≤–∞ —É—á–∏—Ç—å—Å—è! –°–∫–∞–∂–∏—Ç–µ, –∫ –∫–∞–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –Ω–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è? (–∏–≥—Ä—ã, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ª–∏—á–Ω–æ–µ)";
            }
            
            // –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –æ–±—É—á–µ–Ω–∏—è, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ—ç—Ç–∞–ø–Ω–æ
            if (dialogState.isLearningMode) {
                // –≠—Ç–∞–ø 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if (!dialogState.learningData.category) {
                    const categoryMatch = lowerMessage.match(/(–∏–≥—Ä|—Ç–µ—Ö–Ω–æ–ª–æ–≥|–ª–∏—á–Ω)/);
                    if (categoryMatch) {
                        let category;
                        if (categoryMatch[0].includes('–∏–≥—Ä')) category = 'games';
                        else if (categoryMatch[0].includes('—Ç–µ—Ö–Ω–æ–ª–æ–≥')) category = 'technology';
                        else if (categoryMatch[0].includes('–ª–∏—á–Ω')) category = 'personal';
                        
                        if (category) {
                            dialogState.learningData.category = category;
                            return `–û—Ç–ª–∏—á–Ω–æ, –∫–∞—Ç–µ–≥–æ—Ä–∏—è "${category}". –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "GoDAY" –∏–ª–∏ "–º–æ—Ç–∏–≤–∞—Ü–∏—è")`;
                        }
                    }
                    return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: –∏–≥—Ä—ã, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ª–∏—á–Ω–æ–µ";
                }
                
                // –≠—Ç–∞–ø 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º—ã
                if (dialogState.learningData.category && !dialogState.learningData.topic) {
                    const topic = message.trim();
                    if (topic.length > 2) {
                        dialogState.learningData.topic = topic.toLowerCase();
                        return `–¢–µ–º–∞ "${topic}" –ø—Ä–∏–Ω—è—Ç–∞. –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ.`;
                    }
                    return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, \"GoDAY\" –∏–ª–∏ \"–º–æ—Ç–∏–≤–∞—Ü–∏—è\")";
                }
                
                // –≠—Ç–∞–ø 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                if (dialogState.learningData.category && dialogState.learningData.topic) {
                    // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
                    if (!knowledgeBase[dialogState.learningData.category]) {
                        knowledgeBase[dialogState.learningData.category] = {};
                    }
                    if (!knowledgeBase[dialogState.learningData.category][dialogState.learningData.topic]) {
                        knowledgeBase[dialogState.learningData.category][dialogState.learningData.topic] = {};
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π
                    const infoKey = `user_${Date.now()}`;
                    knowledgeBase[dialogState.learningData.category][dialogState.learningData.topic][infoKey] = message;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
                    await saveLearnedData();
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è
                    const learnedCategory = dialogState.learningData.category;
                    const learnedTopic = dialogState.learningData.topic;
                    dialogState.isLearningMode = false;
                    dialogState.learningData = { category: null, topic: null };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏
                    const learnMsg = document.createElement('div');
                    learnMsg.className = 'learn-message';
                    learnMsg.textContent = `‚úì –ó–∞–ø–æ–º–Ω–∏–ª–∞ –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–º–µ "${learnedTopic}" –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${learnedCategory}"`;
                    chatMessages.appendChild(learnMsg);
                    
                    return "–°–ø–∞—Å–∏–±–æ! –Ø –∑–∞–ø–æ–º–Ω–∏–ª–∞ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ú–æ–≥—É —á–µ–º-—Ç–æ –µ—â–µ –ø–æ–º–æ—á—å?";
                }
            }
            
            return null;
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            let response = null;
            let topic = null;
            
            // 0. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ –æ–±—É—á–µ–Ω–∏—è
            response = await handleLearningCommands(message);
            if (response) {
                addBotMessage(response);
                return;
            }
            
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (–∏–º—è, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è)
            if (!dialogState.userName && /(–∑–æ–≤—É—Ç|–∏–º—è|–æ–±—Ä–∞—â–∞—Ç—å—Å—è)/.test(lowerMessage)) {
                const nameMatch = message.match(/(–º–µ–Ω—è –∑–æ–≤—É—Ç|–º–æ–µ –∏–º—è|—è) ([–ê-–Ø–∞-—è–Å—ëA-Za-z]+)/i);
                if (nameMatch && nameMatch[2]) {
                    dialogState.userName = nameMatch[2];
                    response = `–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ${dialogState.userName}! –¢–µ–ø–µ—Ä—å —è –±—É–¥—É –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –≤–∞–º –ø–æ –∏–º–µ–Ω–∏. –ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?`;
                } else {
                    response = "–ö–∞–∫ –º–Ω–µ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?";
                }
            }
            else if (dialogState.userName && /(–ø–æ–º–µ–Ω—è–π –∏–º—è|–∏–∑–º–µ–Ω–∏ –∏–º—è|—Å–º–µ–Ω–∏—Ç—å –∏–º—è)/.test(lowerMessage)) {
                response = "–ö–æ–Ω–µ—á–Ω–æ! –ö–∞–∫ –≤–∞–º —Ç–µ–ø–µ—Ä—å —É–¥–æ–±–Ω–æ, —á—Ç–æ–±—ã —è –≤–∞—Å –Ω–∞–∑—ã–≤–∞–ª–∞?";
                dialogState.userName = null;
            }
            
            // 2. –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            if (!response) {
                // –ò–≥—Ä—ã
                if (/goday|–∏–≥—Ä–∞|—É—Ä–æ–≤–µ–Ω—å|–≥–µ–π–º|–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ/.test(lowerMessage)) {
                    topic = 'games';
                    if (/goday.*—É—Ä–æ–≤–µ–Ω—å|—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π/.test(lowerMessage)) {
                        response = knowledgeBase.games.goday.levels.description;
                        if (/—É—Ä–æ–≤–µ–Ω—å [0-9]+/.test(lowerMessage)) {
                            const level = lowerMessage.match(/—É—Ä–æ–≤–µ–Ω—å ([0-9]+)/)[1];
                            response = knowledgeBase.games.goday.levels.details[level] || 
                                       `–£—Ä–æ–≤–µ–Ω—å ${level}: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ú–æ–≥—É –¥–∞—Ç—å –æ–±—â–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—é.`;
                        }
                    } else if (/—Å–æ–≤–µ—Ç|–ø–æ–¥—Å–∫–∞–∑–∫–∞|–ø–æ–º–æ—â—å/.test(lowerMessage)) {
                        response = knowledgeBase.games.goday.tips;
                    } else if (/—Å–µ–∫—Ä–µ—Ç|–ø–∞—Å—Ö–∞–ª–∫–∞|—Ç–∞–π–Ω–∞/.test(lowerMessage)) {
                        response = knowledgeBase.games.goday.secrets;
                    } else if (/russia stars|—Ä–∞—à–∞ —Å—Ç–∞—Ä—Å/.test(lowerMessage)) {
                        if (/—Å–æ–∑–¥–∞—Ç–µ–ª—å|–∫—Ç–æ —Å–¥–µ–ª–∞–ª|–∞–≤—Ç–æ—Ä/.test(lowerMessage)) {
                            response = knowledgeBase.games['russia stars'].creator;
                        } else {
                            response = knowledgeBase.games['russia stars'].tips;
                        }
                    }
                }
                // –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
                else if (/–∏–∏|–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç|–Ω–µ–π—Ä–æ—Å–µ—Ç—å|ai/.test(lowerMessage)) {
                    topic = 'technology';
                    response = knowledgeBase.technology.–∏–∏.description;
                    if (/–ø—Ä–∏–º–µ—Ä|–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ|–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ/.test(lowerMessage)) {
                        response += "\n" + knowledgeBase.technology.–∏–∏.examples;
                    }
                }
                else if (/–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä|–∫–æ–¥|—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞|—è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä/.test(lowerMessage)) {
                    topic = 'technology';
                    if (/—è–∑—ã–∫|language/.test(lowerMessage)) {
                        response = knowledgeBase.technology.–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ.languages;
                    } else {
                        response = knowledgeBase.technology.–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ.advice;
                    }
                }
                // –õ–∏—á–Ω–æ–µ
                else if (/—Å–æ–≤–µ—Ç|—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è|–ø–æ–º–æ–≥–∏/.test(lowerMessage)) {
                    topic = 'personal';
                    if (/—Ä–∞–±–æ—Ç–∞|–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å|–¥–µ–ª–æ/.test(lowerMessage)) {
                        response = knowledgeBase.personal.—Å–æ–≤–µ—Ç.work;
                    } else {
                        response = knowledgeBase.personal.—Å–æ–≤–µ—Ç.general;
                    }
                }
                else if (/–º–æ—Ç–∏–≤–∞—Ü–∏—è|–º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å|–ª–µ–Ω—å/.test(lowerMessage)) {
                    topic = 'personal';
                    response = knowledgeBase.personal.–º–æ—Ç–∏–≤–∞—Ü–∏—è.tips;
                }
                // –û–±—É—á–µ–Ω–∏–µ
                else if (/–∫–∞–∫ —Ç–µ–±—è –Ω–∞—É—á–∏—Ç—å|–∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é|–∫–∞–∫ –æ–±—É—á–∏—Ç—å/.test(lowerMessage)) {
                    response = "–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—É—á–∏—Ç—å –º–µ–Ω—è –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏! –ü—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏—Ç–µ:\n" +
                               "1. \"–ù–∞—É—á–∏ –º–µ–Ω—è\" –∏–ª–∏ \"–î–æ–±–∞–≤—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\"\n" +
                               "2. –£–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–∏–≥—Ä—ã, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ª–∏—á–Ω–æ–µ)\n" +
                               "3. –£–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É\n" +
                               "4. –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å\n\n" +
                               "–ù–∞–ø—Ä–∏–º–µ—Ä: \"–ù–∞—É—á–∏ –º–µ–Ω—è\", –∑–∞—Ç–µ–º \"–∏–≥—Ä—ã\", –∑–∞—Ç–µ–º \"–Ω–æ–≤–∞—è –∏–≥—Ä–∞\", –∑–∞—Ç–µ–º \"–≠—Ç–æ –∏–≥—Ä–∞ –ø—Ä–æ –∫–æ—Å–º–æ—Å\"";
                }
            }
            
            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–Ω–∞–Ω–∏–π (–µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–∑–µ)
            if (!response) {
                for (const category in knowledgeBase) {
                    for (const topic in knowledgeBase[category]) {
                        // –ò—â–µ–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ–º—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
                        if (lowerMessage.includes(topic.toLowerCase())) {
                            const topicData = knowledgeBase[category][topic];
                            // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                            const userKeys = Object.keys(topicData).filter(k => k.startsWith('user_'));
                            if (userKeys.length > 0) {
                                const latestKey = userKeys[userKeys.length - 1];
                                response = topicData[latestKey];
                                break;
                            }
                        }
                    }
                    if (response) break;
                }
            }
            
            // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π
            if (!response) {
                if (dialogState.userMood === 'positive') {
                    const replies = emotionalResponses.positive;
                    response = replies[Math.floor(Math.random() * replies.length)];
                } 
                else if (dialogState.userMood === 'negative') {
                    const replies = emotionalResponses.negative;
                    response = replies[Math.floor(Math.random() * replies.length)] + " –ú–æ–≥—É —á–µ–º-—Ç–æ –ø–æ–º–æ—á—å?";
                }
            }
            
            // 5. –û–±—â–∏–µ —Ñ—Ä–∞–∑—ã
            if (!response) {
                if (/–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|–¥–æ–±—Ä—ã–π/.test(lowerMessage)) {
                    response = dialogState.userName ? 
                              `–ü—Ä–∏–≤–µ—Ç, ${dialogState.userName}! –ß–µ–º –∑–∞–π–º—ë–º—Å—è —Å–µ–≥–æ–¥–Ω—è?` : 
                              "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?";
                }
                else if (/–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ —Ç—ã/.test(lowerMessage)) {
                    response = "–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏. üòä";
                }
                else if (/—á—Ç–æ —É–º–µ–µ—à—å|–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏|—Ñ—É–Ω–∫—Ü–∏–∏/.test(lowerMessage)) {
                    response = `–Ø –º–æ–≥—É:
1. –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ–± –∏–≥—Ä–∞—Ö (GoDAY, Russia Stars)
2. –û–±—Å—É–¥–∏—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (–ò–ò, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)
3. –î–∞—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
4. –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –±–µ—Å–µ–¥—É –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã
5. –£—á–∏—Ç—å—Å—è –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç –≤–∞—Å!

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?`;
                }
                else if (/—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é/.test(lowerMessage)) {
                    response = dialogState.userName ? 
                              `–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, ${dialogState.userName}! üòä` : 
                              "–†–∞–¥–∞ –±—ã–ª–∞ –ø–æ–º–æ—á—å! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –µ—â—ë.";
                }
                else if (/–ø–æ–∫–∞|–¥–æ —Å–≤–∏–¥–∞–Ω|–∑–∞–≤–µ—Ä—à–∏—Ç—å/.test(lowerMessage)) {
                    response = dialogState.userName ? 
                              `–î–æ —Å–≤–∏–¥–∞–Ω–∏—è, ${dialogState.userName}! –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å, –µ—Å–ª–∏ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã. üëã` : 
                              "–î–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á! –ë—É–¥—É —Ä–∞–¥–∞ –ø–æ–º–æ—á—å —Å–Ω–æ–≤–∞.";
                }
            }
            
            // 6. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
            if (!response) {
                // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                if (dialogState.context.length > 0) {
                    const lastUserMessage = dialogState.context[dialogState.context.length - 2]?.content;
                    if (lastUserMessage) {
                        if (/–¥–∞|–∫–æ–Ω–µ—á–Ω–æ|—Å–æ–≥–ª–∞—Å–µ–Ω/.test(lowerMessage)) {
                            response = "–û—Ç–ª–∏—á–Ω–æ! –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ?";
                        } else if (/–Ω–µ—Ç|–Ω–µ/.test(lowerMessage)) {
                            response = "–ü–æ–Ω—è–ª–∞. –ú–æ–∂–µ—Ç, –æ–±—Å—É–¥–∏–º —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ?";
                        }
                    }
                }
                
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–º–æ–≥, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã
                if (!response) {
                    const lastTopicPhrase = dialogState.currentTopic ? 
                        `–í—ã —É–ø–æ–º–∏–Ω–∞–ª–∏ ${dialogState.currentTopic}. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —ç—Ç—É —Ç–µ–º—É?` : 
                        "";
                    
                    const replies = [
                        `–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å. ${lastTopicPhrase}`,
                        "–ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å? –Ø –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞.",
                        "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –º–µ–Ω—è –Ω–µ—Ç —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ú–æ–∂–µ—Ç, –æ–±—Å—É–¥–∏–º —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ?",
                        "–Ø –≤—Å—ë –µ—â—ë —É—á—É—Å—å. –ú–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ-–¥—Ä—É–≥–æ–º—É?",
                        "–•–æ—Ç–∏—Ç–µ –Ω–∞—É—á–∏—Ç—å –º–µ–Ω—è –æ—Ç–≤–µ—Ç—É –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å? –°–∫–∞–∂–∏—Ç–µ \"–ù–∞—É—á–∏ –º–µ–Ω—è\""
                    ];
                    
                    response = replies[Math.floor(Math.random() * replies.length)];
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
            if (topic) {
                dialogState.currentTopic = topic;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É
            if (dialogState.userMood === 'positive' && !/[üòä‚ú®üåü]/.test(response)) {
                response += " üòä";
            } else if (dialogState.userMood === 'negative' && !/[üòî]/.test(response)) {
                response = "–ü–æ–Ω–∏–º–∞—é... " + response;
            }
            
            // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            if (dialogState.userName && !new RegExp(dialogState.userName, 'i').test(response)) {
                response = response.replace(/([.!?] )/, `, ${dialogState.userName}$1`);
            }
            
            // –°–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã (40% chance)
            addBotMessage(response, Math.random() < 0.4);
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function getCurrentTime() {
            const now = new Date();
            return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            userInput.focus();
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        setInterval(updateLimitCounter, 60000);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        if ('visualViewport' in window) {
            const visualViewport = window.visualViewport;
            
            visualViewport.addEventListener('resize', function() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–≤—ã—Å–æ—Ç–∞ viewport —É–º–µ–Ω—å—à–∏–ª–∞—Å—å)
                if (visualViewport.height < window.innerHeight) {
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // –ü–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å
                    setTimeout(() => {
                        userInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                }
            });
        }
    </script>
</body>
</html>
